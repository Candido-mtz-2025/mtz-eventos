<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./logo.png">
    <link rel="apple-touch-icon" href="./logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema MTZ Eventos - V11 Final</title>

    <link rel="manifest" href="./manifest.json?v=123">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <script src="https://accounts.google.com/gsi/client" async defer></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    /* Filtros Auditoria: deixa como ‚Äúchips‚Äù uniformes */
.audit-filters .btn{
  border-radius: 10px;
  padding: 8px 12px;      /* altura consistente */
  line-height: 1;
  box-shadow: none;
  transform: none;        /* evita pular no hover */
}

/* D√° uma ‚Äúcara de selecionado‚Äù sem mudar a cor do bot√£o */
.audit-filters .btn.active{
  outline: 2px solid rgba(255,255,255,0.85);
  outline-offset: 2px;
}

/* No tema claro, o outline branco pode sumir; ajusta */
[data-theme="light"] .audit-filters .btn.active{
  outline: 2px solid rgba(15, 23, 42, 0.35);
}

        /* === ESTILO V9: CLEAN & MODERN === */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --primary: #2563eb; /* Azul um pouco mais forte */
            --primary-hover: #1d4ed8;
            
            /* MUDAN√áA PRINCIPAL AQUI: Fundo mais escuro para destacar os cart√µes */
            --bg: #e2e8f0; 
            
            --surface: #ffffff; /* Cart√µes continuam brancos */
            --surface-hover: #f8fafc;
            
            --text: #0f172a; /* Texto quase preto para leitura n√≠tida */
            --text-light: #64748b;
            
            --border: #cbd5e1; /* Bordas mais vis√≠veis */
            --input-bg: #f1f5f9;
            
            /* Sombra mais forte para dar efeito 3D */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        /* === MELHORIA DO MODAL (CABE√áALHO E BOT√ÉO X) === */
        .modal-header {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text);
            font-weight: 700;
        }

        .btn-close-modal {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            font-size: 1rem;
        }

        .btn-close-modal:hover {
            background: #ef4444;
            color: white;
            transform: rotate(90deg);
        }

        /* === ESTILO DO CARRINHO (MELHORIA VISUAL) === */
        .box-carrinho {
            background: #f8fafc;
            border: 1px dashed #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        /* Ajuste espec√≠fico para o MODO ESCURO */
        [data-theme="dark"] .box-carrinho {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid #334155;
        }

        /* √Årea da lista de itens */
        #carrinhoList {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        /* Texto de "Nenhum item" mais vis√≠vel */
        #carrinhoList i {
            color: var(--text-light);
            opacity: 0.8;
            font-style: normal;
        }
        
        /* Itens adicionados na lista */
        .item-carrinho {
            display: flex;
            justify-content: space-between;
            background: var(--surface-hover);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
            animation: fadeIn 0.3s;
        }

        [data-theme="dark"] {
            --primary: #60a5fa;
            --primary-hover: #3b82f6;
            --bg: #0f172a; 
            --surface: #1e293b; 
            --surface-hover: #334155;
            --text: #f8fafc;
            --text-light: #94a3b8;
            --border: #334155;
            --input-bg: #0f172a;
            --shadow: none;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; -webkit-font-smoothing: antialiased; }
        * { box-sizing: border-box; }

        /* CONTAINERS & CARDS */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card, .dash-section, .modal-content, .login-box {
            background: var(--surface) !important;
            border: none; 
            box-shadow: var(--shadow);
            border-radius: var(--radius);
            color: var(--text);
            padding: 25px;
            margin-bottom: 24px;
        }

        /* LOGIN */
        #loginArea { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-box { width: 100%; max-width: 400px; text-align: center; }

        /* INPUTS MODERNOS */
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-group { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        
        /* === REFINAMENTOS MOBILE (MODO CELULAR) === */
        @media (max-width: 768px) {
            .container { padding: 15px; padding-bottom: 80px; }
            header .container { flex-direction: column; gap: 15px; align-items: stretch; text-align: center; }
            .logo { margin-bottom: 5px; }
            header .container > div:last-child { justify-content: center; }
            .form-row { flex-direction: column; gap: 15px; }
            input, select, button, textarea { font-size: 16px !important; }
            .dashboard-grid { grid-template-columns: 1fr; gap: 15px; }
            .stat-card { padding: 20px; }
            .tabs { padding: 10px 5px; justify-content: flex-start; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
            .tabs::-webkit-scrollbar { display: none; }
            .tab-btn { flex-shrink: 0; padding: 10px 16px; font-size: 0.9rem; border: 1px solid var(--border); margin-right: 5px; }
            .table th, .table td { padding: 12px 10px; font-size: 0.85rem; }
            .actions-cell { gap: 5px; }
            .btn-sm { padding: 8px 10px; font-size: 1rem; }
            .modal { align-items: flex-end; }
            .modal-content { width: 100%; max-width: 100%; border-radius: 20px 20px 0 0; margin: 0; max-height: 90vh; overflow-y: auto; }
            #modalScanner .modal-content { border-radius: 12px; margin: 20px; align-self: center; }
            .card .btn-primary, .card .btn-success { padding: 15px; font-size: 1rem; }
            .login-box { padding: 30px 20px; width: 90%; }
        }

        label { font-size: 0.85rem; font-weight: 600; color: var(--text-light); margin-left: 2px; }
        input, select {
            background: var(--input-bg);
            color: var(--text);
            border: 1px solid transparent; padding: 12px 15px;
            border-radius: 10px; width: 100%; outline: none; transition: 0.2s; font-size: 0.95rem;
        }
        input:focus, select:focus { background: var(--surface); border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); }

        /* TABELAS CLEAN */
        .table-responsive { border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
        .table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .table th { background: var(--surface-hover); color: var(--text-light); padding: 14px 20px; text-transform: uppercase; font-size: 0.75rem; font-weight: 700; border-bottom: 1px solid var(--border); text-align: left; }
        .table td { padding: 16px 20px; vertical-align: middle; color: var(--text); border-bottom: 1px solid var(--border); }
        .table tbody tr:hover { background-color: var(--surface-hover); }
        .col-actions { text-align: right !important; width: 1%; white-space: nowrap; }
        .actions-cell { display: flex; justify-content: flex-end; gap: 8px; }

        /* BOT√ïES & BADGES */
        .btn { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: 0.2s; }
        .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-info { background: #0ea5e9; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; }
        
        .badge { padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef9c3; color: #854d0e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #e0f2fe; color: #075985; }

        /* DASHBOARD GRID */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { display: flex; align-items: center; justify-content: space-between; padding: 25px; position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .card-blue::before { background: #3b82f6; } .card-blue .stat-icon { background: #eff6ff; color: #3b82f6; }
        .card-orange::before { background: #f59e0b; } .card-orange .stat-icon { background: #fffbeb; color: #f59e0b; }
        .card-green::before { background: #10b981; } .card-green .stat-icon { background: #ecfdf5; color: #10b981; }
        .card-purple::before { background: #8b5cf6; } .card-purple .stat-icon { background: #f5f3ff; color: #8b5cf6; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .stat-info h3 { font-size: 1.8rem; margin: 0; }
        
/* ============================================= */
/* ALINHAMENTO PERFEITO DAS TABS */
/* ============================================= */
/* CONTAINER DAS ABAS */
.tabs-container{
  width: 100%;
  display: flex;
  justify-content: flex-start;
}

/* BARRA (igual largura dos cards) */
.tabs{
  width: 100%;                 /* <- chave: mesma largura do conte√∫do */
  display: flex;               /* barra pode ser flex sem problema */
  justify-content: flex-start; /* bot√µes come√ßam na esquerda */
  align-items: center;
  gap: 5px;

  overflow-x: auto;
  -webkit-overflow-scrolling: touch;

  padding: 5px;                /* mesmo ‚Äúrespiro‚Äù do design */
  background: var(--surface);
  border-radius: 12px;
  border: 1px solid var(--border);
  margin-bottom: 25px;

  box-sizing: border-box;
}

/* bot√µes */
.tab-btn{
  flex: 0 0 auto;              /* n√£o deixa bot√£o esticar */
  background: transparent;
  border: none;
  padding: 10px 20px;
  color: var(--text-light);
  font-weight: 600;
  cursor: pointer;
  border-radius: 8px;
  white-space: nowrap;
}

.tab-btn {
  background: transparent;
  border: none;
  padding: 10px 20px;
  color: var(--text-light);
  font-weight: 600;
  cursor: pointer;
  border-radius: 8px;
  white-space: nowrap;
}

.tab-btn.active {
  background: var(--primary);
  color: white;
}

.tab-content {
  display: none;
  animation: fadeIn 0.3s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}
    /* Linha de filtros (Auditoria e outras √°reas) */
.filters-row{
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  overflow-x: auto;
  padding-bottom: 5px;

  justify-content: flex-start;
  align-items: center;

  width: 100%;
  box-sizing: border-box;
}
.audit-header{
  display:flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 14px;
  flex-wrap: wrap;
}

.audit-title{
  margin: 0;
  display:flex;
  align-items:center;
  gap: 8px;
}

.audit-actions{
  display:flex;
  gap: 10px;
  align-items:center;
}

.audit-filters{
  display:flex;
  gap: 8px;
  margin-bottom: 18px;
  overflow-x: auto;
  padding-bottom: 6px;
  -webkit-overflow-scrolling: touch;
}

.audit-footer-info{
  margin-top: 14px;
  padding: 12px;
  background: var(--bg);
  border-radius: 8px;
}

        /* OUTROS */
        header .container { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }
        .logo h1 { font-size: 1.6rem; color: var(--text) !important; margin: 0; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 5000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .sync-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px; text-transform: uppercase; }
        .sync-online { background: #dcfce7; color: #166534; }
        .sync-offline { background: #f1f5f9; color: #475569; }
        .sync-saving { background: #fff7ed; color: #9a3412; }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 6000; left: 50%; bottom: 30px; transform: translateX(-50%); opacity: 0; transition: 0.3s; }
        #toast.show { visibility: visible; bottom: 40px; opacity: 1; }

        /* IMPRESS√ÉO (Mantido para PDF funcionar) */
        .invoice-box { background: #fff !important; color: #333 !important; padding: 40px; }
        .invoice-table th { background: #000 !important; color: #fff !important; }
        .scanner-box { background: #000; height: 250px; overflow: hidden; position: relative; }
        #interactive video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="loginArea">
        <div class="login-box">
            <h1 style="color:var(--primary); margin-bottom:5px;">MTZ Eventos</h1>
            <p style="margin-bottom: 30px; color:var(--text-light);">Sistema de Gest√£o & Loca√ß√£o V11</p>
            
            <button id="btnLoginGoogle" class="btn" style="width: 100%; margin-bottom: 15px; background-color: #1e293b; color: white; justify-content: center; padding: 14px;" onclick="fazerLoginGoogle()">
                <i class="bi bi-google"></i> Entrar com Google
            </button>
            <button class="btn" style="width: 100%; background-color: var(--primary); color: white; justify-content: center; padding: 14px;" onclick="entrarOffline()">
                <i class="bi bi-hdd"></i> Usar Offline (Local)
            </button>
        </div>
    </div>

    <div id="appArea" style="display: none;">
        <header>
            <div class="container">
                <div class="logo">
                    <h1>MTZ Eventos</h1>
                    <p style="font-size:0.85rem; color:var(--text-light);">Painel de Controle</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div id="syncBadge" class="sync-badge sync-offline"><i class="bi bi-circle-fill"></i> <span id="syncText">Offline</span></div>
                    <button class="btn btn-secondary btn-sm" onclick="toggleTheme()"><i class="bi bi-moon"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="sair()"><i class="bi bi-box-arrow-right"></i></button>
                </div>
            </div>
        </header>

        <div class="container">
               <div class="tabs-container">
    <div class="tabs">
        <button class="tab-btn active" onclick="abrirTab('dashboard')"><i class="bi bi-grid"></i> Dashboard</button>
        <button class="tab-btn" onclick="abrirTab('locadores')"><i class="bi bi-people"></i> Clientes</button>
        <button class="tab-btn" onclick="abrirTab('tipos')"><i class="bi bi-tags\"></i> Tipos</button>
        <button class="tab-btn" onclick="abrirTab('estoque')"><i class="bi bi-box-seam"></i> Estoque</button>
        <button class="tab-btn" onclick="abrirTab('locacoes')"><i class="bi bi-cart"></i> Loca√ß√µes</button>
        <button class="tab-btn" onclick="abrirTab('devolucoes')"><i class="bi bi-arrow-return-left"></i> Devolu√ß√µes</button>
        <button class="tab-btn" onclick="abrirTab('auditoria')"><i class="bi bi-shield-check"></i> Auditoria</button>
        <button class="tab-btn" onclick="abrirTab('config')"><i class="bi bi-gear"></i> Config</button>
    </div>
</div>

            <div id="tab-dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card card-blue" onclick="abrirTab('locadores')">
                        <div class="stat-info"><h3 id="dashClientes">0</h3><p>Clientes</p></div>
                        <div class="stat-icon"><i class="bi bi-people"></i></div>
                    </div>
                    <div class="stat-card card-orange" onclick="irParaLocacoes('todos')">
                        <div class="stat-info"><h3 id="dashLocacoes">0</h3><p>Loca√ß√µes Ativas</p></div>
                        <div class="stat-icon"><i class="bi bi-cart"></i></div>
                    </div>
                    <div class="stat-card card-green">
                        <div class="stat-info"><h3 id="dashFaturamento" style="font-size:1.4rem;">R$ 0,00</h3><p>Receita</p></div>
                        <div class="stat-icon"><i class="bi bi-currency-dollar"></i></div>
                    </div>
                    <div class="stat-card card-purple" onclick="irParaLocacoes('atrasado')">
                        <div class="stat-info"><h3 id="dashAtrasos">0</h3><p>Atrasos</p></div>
                        <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    </div>
                </div>
                <div class="dashboard-lower">
                    <div class="dash-section">
                        <h3><i class="bi bi-calendar-event"></i> Pr√≥ximas Devolu√ß√µes</h3>
                        <div class="table-responsive">
                            <table class="table"><thead><tr><th>Data</th><th>Cliente</th><th style="text-align:center">Status</th></tr></thead><tbody id="tblDashDevolucoes"></tbody></table>
                        </div>
                    </div>
                    <div class="dash-section">
                        <h3><i class="bi bi-box-seam"></i> Avisos</h3>
                        <div id="listEstoqueBaixo"><small style="color:var(--text-light)">Sistema operando normalmente.</small></div>
                    </div>
                </div>
            </div>

            <div id="tab-locadores" class="tab-content">
                <div class="card">
                    <h3>Novo Cliente</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Nome Completo</label><input type="text" id="locNome" placeholder="Ex: Jo√£o Silva"></div>
                        <div class="form-group"><label>CPF / CNPJ</label><input type="text" id="locDoc" placeholder="Documento"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Endere√ßo</label><input type="text" id="locEnd"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Email</label><input type="email" id="locEmail"></div>
                        <div class="form-group"><label>Telefone</label><input type="tel" id="locTel"></div>
                    </div>
                    <button class="btn btn-primary" onclick="salvarLocador()"><i class="bi bi-plus-lg"></i> Cadastrar</button>
                </div>
                <div class="card">
                    <input type="text" id="buscaCliente" placeholder="üîç Buscar cliente..." onkeyup="buscarComDebounce('locadores')" style="margin-bottom: 15px;">
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Cliente</th><th>Email</th><th>Telefone</th><th class="col-actions">A√ß√µes</th></tr></thead>
                            <tbody id="tblLocadores"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-tipos" class="tab-content">
                <div class="card">
                    <h3>Novo Tipo</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Nome</label><input type="text" id="tipoNome"></div>
                        <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="tipoDesc"></div>
                    </div>
                    <button class="btn btn-primary" onclick="salvarTipo()">Salvar Tipo</button>
                </div>
                <div class="card">
                    <div class="table-responsive"><table class="table"><thead><tr><th>Nome</th><th>Descri√ß√£o</th><th class="col-actions">A√ß√µes</th></tr></thead><tbody id="tblTipos"></tbody></table></div>
                </div>
            </div>

            <div id="tab-estoque" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Stock de Pe√ßas</h2>
                    <button class="btn btn-success" onclick="document.getElementById('inputExcel').click()"><i class="bi bi-file-earmark-spreadsheet"></i> Importar Excel</button>
                </div>
                <input type="file" id="inputExcel" accept=".xlsx, .xls" style="display:none" onchange="processarExcelInteligente(this)">
                
                <div class="card">
                    <h3>Novo Item</h3>
                    <div class="form-row">
                        <div class="form-group"><label>C√≥digo</label><input type="text" id="pecaCod"></div>
                        <div class="form-group"><label>Categoria</label><select id="pecaTipo"></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Nome</label><input type="text" id="pecaNome"></div>
                        <div class="form-group"><label>Medida</label><input type="text" id="pecaMedida"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Foto (URL ou Arquivo)</label><input type="file" id="pecaFoto" accept="image/*"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Valor (R$)</label><input type="number" id="pecaValor" step="0.01"></div>
                        <div class="form-group"><label>Qtd Total</label><input type="number" id="pecaQtd" value="1"></div>
                        <div class="form-group"><label>C√≥d Barras</label><div style="display:flex; gap:5px;"><input type="text" id="pecaBar"><button class="btn btn-secondary" onclick="iniciarScanner('cadastro')"><i class="bi bi-qr-code"></i></button></div></div>
                    </div>
                    <button class="btn btn-primary" onclick="salvarPeca()">Salvar Item</button>
                </div>
                <div class="card">
                   <div class="card">
  <input type="text" id="buscaEstoque" placeholder="üîç Buscar item..." onkeyup="buscarComDebounce('estoque')" style="margin-bottom: 12px;">

  <!-- BOT√ÉO AQUI (entre o input e a tabela) -->
  <div style="display:flex; gap:10px; margin-bottom:12px; flex-wrap:wrap;">
    <button class="btn btn-danger btn-sm" onclick="excluirSelecionadosEstoque()">
      <i class="bi bi-trash"></i> Excluir selecionados
    </button>
  </div>

  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr>
          <th style="width:40px;">
            <input type="checkbox" id="chkAllEstoque"
                   onchange="toggleSelecionarTodosEstoque(this.checked)">
          </th>
          <th>Img</th>
          <th>C√≥d</th>
          <th>Tipo</th>
          <th>Nome</th>
          <th>Valor</th>
          <th>Estoque</th>
          <th class="col-actions">A√ß√µes</th>
        </tr>
      </thead>
    <tbody id="tblEstoque"></tbody>
            </table>
          </div>
        </div> 
      </div> 
    </div> <div id="tab-locacoes" class="tab-content">
        <div class="card">
            <h3>Nova Loca√ß√£o</h3>
            <div class="form-row">
                <div class="form-group"><label>Cliente</label><select id="aluguelCliente"></select></div>
                <div class="form-group"><label>Divisor (Gross-up)</label><input type="number" id="aluguelDivisor" value="0.8367" step="0.0001"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Data In√≠cio</label><input type="date" id="aluguelIni"></div>
                <div class="form-group"><label>Previs√£o Fim</label><input type="date" id="aluguelFim"></div>
            </div>
                    <div class="box-carrinho">
                        <h4 style="margin-top:0; margin-bottom: 15px; display:flex; align-items:center; gap:8px;">
                            <i class="bi bi-cart-plus" style="color:var(--primary)"></i> Itens do Pedido
                        </h4>
                        
                        <div class="form-row" style="align-items: flex-end;">
                            <div class="form-group" style="flex: 4;">
                                <label>Selecionar Item</label>
                                <select id="aluguelItemSelect" onchange="atualizarLimiteEstoque()"></select>
                            </div>
                            
                            <div class="form-group" style="flex: 1; min-width: 70px;">
                                <label>Qtd <small id="avisoEstoque" style="color:red; font-weight:bold; font-size:10px;"></small></label>
                                <input type="number" id="aluguelQtd" value="1" min="1" style="text-align:center;" oninput="validarDigitacao(this)">
                            </div>
                            
                            <div class="form-group" style="flex: 2; display:flex; gap: 5px;">
                                <button class="btn btn-success" style="flex:1;" onclick="addItemCarrinho()">
                                    <i class="bi bi-plus-lg"></i> Add
                                </button>
                                <button class="btn btn-secondary" style="width: 50px;" onclick="iniciarScanner('locacao')" title="Ler QR Code">
                                    <i class="bi bi-qr-code"></i>
                                </button>
                            </div>
                        </div>

                        <div id="carrinhoList">
                            <i><i class="bi bi-info-circle"></i> Nenhum item adicionado √† lista.</i>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="finalizarLocacao()">Concluir Loca√ß√£o</button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px;">
                    <button class="btn btn-sm btn-secondary" onclick="mudarFiltro('todos')">Todos</button>
                    <button class="btn btn-sm btn-success" onclick="mudarFiltro('ativo')">Em Aberto</button>
                    <button class="btn btn-sm btn-danger" onclick="mudarFiltro('atrasado')">Atrasados</button>
                    <button class="btn btn-sm btn-info" onclick="mudarFiltro('devolvido')">Hist√≥rico</button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr><th>Cliente</th><th>Per√≠odo</th><th>Valor</th><th>Status</th><th class="col-actions">A√ß√µes</th></tr>
                            </thead>
                            <tbody id="tblLocacoes"></tbody>
                        </table>
                    </div>
                </div>
            </div> <div id="tab-devolucoes" class="tab-content">
                <div class="card">
                    <h3>Registrar Devolu√ß√£o</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Loca√ß√£o Pendente</label><select id="devLocacao" onchange="carregarItensDevolucao()"></select></div>
                        <div class="form-group"><label>Data Devolu√ß√£o</label><input type="date" id="devData"></div>
                    </div>
                    <div id="divItensDevolucao" style="margin: 15px 0; background: var(--bg); padding: 15px; border-radius: 8px;">
                        <small style="color:var(--text-light)">Selecione uma loca√ß√£o para conferir.</small>
                    </div>
                    <button class="btn btn-primary" onclick="confirmarDevolucao()"><i class="bi bi-check-lg"></i> Confirmar Baixa</button>
                </div>
                <div class="card">
                    <h3>Hist√≥rico Recente</h3>
                    <div class="table-responsive"><table class="table"><thead><tr><th>Cliente</th><th>Data</th><th>Status</th><th class="col-actions">Recibo</th></tr></thead><tbody id="tblDevolucoes"></tbody></table></div>
                </div>
            </div>

            <div id="tab-config" class="tab-content">
                <div class="card">
                    <h3>Personaliza√ß√£o</h3>
                    <div class="form-row"><div class="form-group"><label>Rodap√© PDF</label><input type="text" id="confRodape"></div></div>
                    <div class="form-row">
                        <div class="form-group"><label>Telefone</label><input type="text" id="confTel"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="confEmail"></div>
                    </div>
                    <div class="form-group"><label>Logo</label><input type="file" id="confLogo" onchange="converterLogo()"></div>
                    <div id="previewLogo" style="margin: 10px 0;"></div>
                    <button class="btn btn-primary" onclick="salvarConfig()">Salvar Configura√ß√µes</button>
                </div>
                
                <div class="card">
                    <h3>Dados & Backup</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-info" onclick="baixarBackup()">Baixar JSON</button>
                        <button class="btn btn-warning" onclick="document.getElementById('fileRestore').click()">Restaurar JSON</button>
                        <button class="btn btn-danger" onclick="arquivarHistorico()">Arquivar (Limpeza)</button>
                        
                        <input type="file" id="fileRestore" style="display: none;" onchange="restaurarBackup(this)">
                    </div>
                </div>
            </div>
<!-- ABA AUDITORIA -->
<div id="tab-auditoria" class="tab-content">
  <div class="card">

    <div class="audit-header">
      <h3 class="audit-title"><i class="bi bi-shield-check"></i> Logs de Auditoria</h3>

      <div class="audit-actions">
        <button class="btn btn-info btn-sm" onclick="exportarLogsCSV()">
          <i class="bi bi-download"></i> Exportar
        </button>
        <button class="btn btn-danger btn-sm" onclick="if(confirm('Limpar logs antigos?')) limparLogsAntigos()">
          <i class="bi bi-trash"></i> Limpar
        </button>
      </div>
    </div>

   <div style="display:flex; gap:10px; margin-bottom:15px; overflow-x:auto; padding-bottom:5px;">
  <button class="btn btn-sm btn-secondary" onclick="renderLogs('todos')">Todos</button>
  <button class="btn btn-sm btn-success"   onclick="renderLogs('cliente')">Clientes</button>
  <button class="btn btn-sm btn-success"   onclick="renderLogs('item')">Itens</button>
  <button class="btn btn-sm btn-warning"   onclick="renderLogs('locacao')">Loca√ß√µes</button>
  <button class="btn btn-sm btn-info"      onclick="renderLogs('devolucao')">Devolu√ß√µes</button>
  <button class="btn btn-sm btn-secondary" onclick="renderLogs('sistema')">Sistema</button>
</div>
      
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>DATA/HORA</th>
            <th>TIPO</th>
            <th>A√á√ÉO</th>
            <th>DESCRI√á√ÉO</th>
            <th>USU√ÅRIO</th>
          </tr>
        </thead>
        <tbody id="tblLogs"></tbody>
      </table>
    </div>

    <div class="audit-footer-info">
      <small style="color:var(--text-light);">
        <i class="bi bi-info-circle"></i>
        <b>Total</b>:
        <span id="totalLogs">0</span>/1000
        | <b>Reten√ß√£o</b>: 90 dias
      </small>
    </div>

  </div>
</div>

    <div id="modalEditarLocador" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Editar Cliente</h3>
      <button class="btn-close-modal" onclick="fecharModal('modalEditarLocador')">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <input type="hidden" id="editLocId">
    <div class="form-group"><label>Nome</label><input type="text" id="editLocNome"></div>
    <div class="form-group"><label>Email</label><input type="email" id="editLocEmail"></div>
    <div class="form-group"><label>Telefone</label><input type="tel" id="editLocTel"></div>

    <div style="margin-top:20px">
      <button class="btn btn-primary" onclick="salvarEdicaoLocador()" style="width:100%">
        <i class="bi bi-check-lg"></i> Salvar Altera√ß√µes
      </button>
    </div>
  </div>
</div>

    <div id="modalEditarTipo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Tipo</h3>
                <button class="btn-close-modal" onclick="fecharModal('modalEditarTipo')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <input type="hidden" id="editTipoId">
            <div class="form-group"><label>Nome</label><input type="text" id="editTipoNome"></div>
            <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="editTipoDesc"></div>
            <div style="margin-top:20px">
                <button class="btn btn-primary" onclick="salvarEdicaoTipo()" style="width:100%">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="modalEditarPeca" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Item</h3>
                <button class="btn-close-modal" onclick="fecharModal('modalEditarPeca')">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <input type="hidden" id="editPecaId">
            <div class="form-row">
                <div class="form-group"><label>C√≥digo</label><input type="text" id="editPecaCod"></div>
                <div class="form-group"><label>Tipo</label><select id="editPecaTipo"></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Nome</label><input type="text" id="editPecaNome"></div>
                <div class="form-group"><label>Medida</label><input type="text" id="editPecaMedida"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Valor</label><input type="number" id="editPecaValor" step="0.01"></div>
                <div class="form-group"><label>Qtd</label><input type="number" id="editPecaQtd"></div>
            </div>
            <div class="form-group"><label>C√≥d Barras</label><input type="text" id="editPecaBar"></div>
            <div style="margin-top:20px">
                <button class="btn btn-primary" onclick="salvarEdicaoPeca()" style="width:100%">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalScanner" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Leitor QR</h3>
                <button class="btn-close-modal" onclick="fecharScanner()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="scanner-box"><div id="interactive" class="viewport"></div></div>
            <p style="text-align:center;">Aponte a c√¢mera</p>
        </div>
    </div>
    
    <div id="modalRelatorio" class="modal">
        <div class="modal-content" style="max-width: 900px; padding: 0; background: #525659; height: 95vh; display: flex; flex-direction: column;">
            <div style="padding: 10px 20px; background: #323639; color: white; display: flex; justify-content: space-between; align-items: center;">
                <span>Visualiza√ß√£o de Impress√£o</span>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary btn-sm" onclick="gerarPDF()"><i class="bi bi-printer"></i> Salvar PDF</button>
                    <button class="btn btn-danger btn-sm" onclick="fecharModal('modalRelatorio')">Fechar</button>
                </div>
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 40px; display: flex; justify-content: center; background: #525659;">
                <div id="printArea" class="invoice-box"></div>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    
<script>
// ========================================
// üî• CACHE DE DOM - OTIMIZA√á√ÉO V11.1
// ========================================
const DOM = {
    _cache: {},
    get(id) {
        if (!this._cache[id]) {
            this._cache[id] = document.getElementById(id);
            if (!this._cache[id]) {
                console.warn(`‚ö†Ô∏è Elemento #${id} n√£o encontrado`);
            }
        }
        return this._cache[id];
    }
};

// === SISTEMA MTZ EVENTOS (V11 FINAL CORRIGIDA) ===
let locadores = [], pecas = [], locacoes = [], devolucoes = [], tipos = [], carrinhoLocacao = [];

    let logsAuditoria = []; // NOVO: Sistema de auditoria
    let config = { rodape: "MTZ Eventos", tel: "", email: "", logo: "" };
    let tokenClient, filtroAtual = 'todos';
    let paginaAtual = {
    locadores: 1,
    pecas: 1,
    locacoes: 1
    };
    const ITENS_POR_PAGINA = 50;

    // Cache para otimizar buscas
    let cacheDisponibilidade = null;
    let ultimaAtualizacaoCache = 0;

    // === DEBOUNCE: EVITA LAG AO DIGITAR ===
function debounce(func, delay) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

// === BUSCA COM DEBOUNCE (ANTI-LAG) ===
const buscarComDebounce = debounce(function(tipo) {
    if (tipo === 'locadores') renderLocadores();
    if (tipo === 'estoque') renderEstoque();
}, 300);

        // ============================================
// SISTEMA DE AUDITORIA - LOGS COMPLETOS
// ============================================

/**
 * Registra uma a√ß√£o no sistema de auditoria
 */
function registrarLog(tipo, acao, descricao, dados = null) {
    const log = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        data: new Date().toLocaleString('pt-BR'),
        tipo: tipo,        // 'cliente', 'item', 'locacao', 'devolucao', 'config', 'sistema'
        acao: acao,        // 'criar', 'editar', 'deletar', 'visualizar', 'exportar'
        descricao: descricao,
        usuario: localStorage.getItem('usuarioEmail') || 'Offline',
        dados: dados       // Dados relevantes da a√ß√£o
    };
    
    logsAuditoria.unshift(log); // Adiciona no in√≠cio
    
    // Limita a 1000 logs (mant√©m √∫ltimos 3 meses aprox.)
    if (logsAuditoria.length > 1000) {
        logsAuditoria = logsAuditoria.slice(0, 1000);
    }
    
    console.log('üìù LOG:', log.tipo, '‚Üí', log.acao, '‚Üí', log.descricao);
}

/**
 * Limpa logs antigos (mais de 90 dias)
 */
function limparLogsAntigos() {
    const treseMesesAtras = Date.now() - (90 * 24 * 60 * 60 * 1000);
    const qtdAntes = logsAuditoria.length;
    
    logsAuditoria = logsAuditoria.filter(log => log.id > treseMesesAtras);
    
    const removidos = qtdAntes - logsAuditoria.length;
    if (removidos > 0) {
        console.log(`üóëÔ∏è ${removidos} logs antigos removidos`);
        registrarLog('sistema', 'limpeza', `${removidos} logs antigos removidos`);
    }
    
    salvarLocal();
}

/**
 * Exporta logs como CSV
 */
function exportarLogsCSV() {
    if (logsAuditoria.length === 0) {
        mostrarToast('Nenhum log para exportar!', 'erro');
        return;
    }
    
    let csv = 'Data,Hora,Tipo,A√ß√£o,Descri√ß√£o,Usu√°rio\n';
    
    logsAuditoria.forEach(log => {
        const data = new Date(log.timestamp);
        const dataStr = data.toLocaleDateString('pt-BR');
        const horaStr = data.toLocaleTimeString('pt-BR');
        
        csv += `"${dataStr}","${horaStr}","${log.tipo}","${log.acao}","${log.descricao}","${log.usuario}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `MTZ-Auditoria-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    registrarLog('sistema', 'exportar', 'Logs de auditoria exportados');
    mostrarToast('Logs exportados com sucesso!');
}

/**
 * Renderiza a tabela de logs
 */
function renderLogs(filtro = 'todos') {
  const tbody = document.getElementById('tblLogs');
  if (!tbody) return;

  // (opcional) ativa bot√£o
  document.querySelectorAll('.audit-filter').forEach(b => b.classList.remove('active'));
  const btnAtivo = document.querySelector(`.audit-filter[data-filter="${filtro}"]`);
  if (btnAtivo) btnAtivo.classList.add('active');

  let logsFiltrados = logsAuditoria;
  if (filtro !== 'todos') {
    logsFiltrados = logsAuditoria.filter(log => log.tipo === filtro);
  }
    const icones = {
        'cliente': 'bi-person',
        'item': 'bi-box',
        'locacao': 'bi-cart',
        'devolucao': 'bi-arrow-return-left',
        'config': 'bi-gear',
        'sistema': 'bi-cpu'
    };
    
    const cores = {
        'criar': '#10b981',
        'editar': '#f59e0b',
        'deletar': '#ef4444',
        'visualizar': '#0ea5e9',
        'exportar': '#8b5cf6'
    };
    
    tbody.innerHTML = logsFiltrados.slice(0, 100).map(log => {
        const data = new Date(log.timestamp);
        const dataStr = data.toLocaleDateString('pt-BR');
        const horaStr = data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
        
        return `
            <tr>
                <td>
                    <div style="font-size:0.85rem; line-height:1.4">${dataStr}</div>
                    <div style="font-size:0.75rem; opacity:0.7">${horaStr}</div>
                </td>
                <td>
                    <i class="bi ${icones[log.tipo] || 'bi-circle'}" style="color:var(--primary); margin-right:4px"></i>
                    <span style="font-size:0.85rem">${log.tipo}</span>
                </td>
                <td>
                    <span style="color:${cores[log.acao]}; font-weight:600; font-size:0.85rem">${log.acao}</span>
                </td>
                <td style="max-width:400px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">
                    ${log.descricao}
                </td>
                <td style="font-size:0.85rem; opacity:0.8">${log.usuario}</td>
            </tr>
        `;
    }).join('');
}

const GOOGLE_CLIENT_ID = '981345912804-uim8kctqnts15kt6l8odhif3hil6udek.apps.googleusercontent.com';
const API_URL = 'https://script.google.com/macros/s/AKfycbxZoCyJZrG2WZfIuPA3Iyz6d-PIdnzFi-Ejnl3gAUB-l9mGnBJt0BpyBErzMI_GFuZuhA/exec';
    
    // --- FORMATA√á√ÉO DE DATA ---
    function formatarData(dataString) {
        if (!dataString) return '<span style="color:#999">---</span>';
        const data = new Date(dataString);
        if (isNaN(data.getTime())) return '<span>Em aberto</span>';
        const dataCorrigida = new Date(data.getTime() + data.getTimezoneOffset() * 60000);
        return dataCorrigida.toLocaleDateString('pt-BR');
    }

    // --- INICIALIZA√á√ÉO ---
    window.onload = function() {
        carregarLocal();
        const hoje = new Date().toISOString().split('T')[0];
        const elIni = document.getElementById('aluguelIni');
        const elDev = document.getElementById('devData');
        if(elIni) elIni.value = hoje;
        if(elDev) elDev.value = hoje;

        // INJE√á√ÉO DE ESTILO FOR√áADO PARA O PDF FICAR PERFEITO
        const style = document.createElement('style');
        style.innerHTML = `
            @media print { @page { margin: 0; } body { background: white; } }
            
           /* CONFIGURA√á√ÉO DA FOLHA A4 CHEIA */
            #printArea { 
                position: relative !important; /* IMPORTANTE: Segura o rodap√© no lugar */
                background-color: #ffffff !important;
                color: #000000 !important; 
                box-shadow: none !important; 
                margin: 0 auto !important; 
                width: 100% !important;
                /* Padding inferior maior (30mm) para o texto n√£o ficar atr√°s da barra preta */
                padding: 15mm 15mm 30mm 15mm !important; 
                min-height: 297mm !important; /* For√ßa altura total A4 */
                display: flex;
                flex-direction: column;
            }
            #printArea * { color: #000000 !important; border-color: #000000 !important; }
            #printArea thead { background-color: #000000 !important; }
            #printArea thead th { color: #ffffff !important; background-color: #000000 !important; }
            #printArea .footer-bar, #printArea .footer-bar div { background-color: #000000 !important; color: #ffffff !important; }
        `;
        document.head.appendChild(style);
        
        if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
        if(window.google) gisLoaded();
        if(localStorage.getItem('gToken')) { entrarApp(); sincronizar('carregar'); }
        iniciarBackupAutomatico();
        setInterval(salvarLocal, 60000); // Auto-salva a cada 1 minuto
        console.log('‚úÖ Sistema de backup ativado');
    };

    function toggleTheme() { 
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark'; 
        body.setAttribute('data-theme', isDark ? 'light' : 'dark'); 
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    function abrirTab(id) { 
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active')); 
        const tab = document.getElementById('tab-'+id);
        if(tab) tab.classList.add('active'); 
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(btn => { if(btn.getAttribute('onclick').includes(id)) btn.classList.add('active'); });
    }
    
    function fecharModal(id) { const m = document.getElementById(id); if(m) m.classList.remove('active'); }

    // --- RENDERIZA√á√ÉO DAS TABELAS ---
    // === RENDERIZAR LOCA√á√ïES COM PAGINA√á√ÉO ===
// ========================================
// üî• RENDERIZAR LOCA√á√ïES OTIMIZADA
// ========================================
function renderLocacoes() {
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    
    const tbody = DOM.get('tblLocacoes');
    if (!tbody) return;
    
    // Processar dados
    const lista = locacoes.map(l => {
        let dataD = l.dataDevolucaoPrevisao ? new Date(l.dataDevolucaoPrevisao) : null;
        let st = l.status;
        if (l.status === 'ativo' && dataD && dataD < hoje) st = 'atrasado';
        
        let total = 0;
        (l.items || []).forEach(i => total += (parseFloat(i.valor) || 0) * (parseInt(i.quantidade) || 1));
        let div = parseFloat(l.divisorFatura) || 1;
        if (div <= 0) div = 1;
        
        return { ...l, statusVisual: st, valorTotal: total / div, pago: l.pago || false };
    });
    
    const filtrados = lista.filter(l => filtroAtual === 'todos' || l.statusVisual === filtroAtual);
    filtrados.sort((a, b) => b.id - a.id);
    
    // Pagina√ß√£o
    const totalPaginas = Math.ceil(filtrados.length / ITENS_POR_PAGINA);
    const inicio = (paginaAtual.locacoes - 1) * ITENS_POR_PAGINA;
    const itensPagina = filtrados.slice(inicio, inicio + ITENS_POR_PAGINA);
    
    if (itensPagina.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; opacity:0.6;">Nenhum registro.</td></tr>';
        return;
    }
    
    // üî• OTIMIZA√á√ÉO: DocumentFragment (1 reflow)
    const fragment = document.createDocumentFragment();
    
    itensPagina.forEach(l => {
        const c = locadores.find(x => x.id === l.locadorId);
        let badgeClass = l.statusVisual === 'atrasado' ? 'badge-danger' : 
                        l.statusVisual === 'devolvido' ? 'badge-info' : 'badge-success';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <div style="font-weight:600">${c ? c.nome : 'Removido'}</div>
                <div style="font-size:0.75rem; opacity:0.7;">#${l.id.toString().slice(-4)}</div>
            </td>
            <td>
                <div style="font-size:0.85rem">${formatarData(l.dataAluguel)}</div>
                <div style="font-size:0.85rem; font-weight:600;">At√© ${formatarData(l.dataDevolucaoPrevisao)}</div>
            </td>
            <td>
                <div style="font-weight:700">R$ ${l.valorTotal.toFixed(2)}</div>
                ${l.pago ? '<span class="badge badge-success">PAGO</span>' : '<span class="badge badge-warning">PENDENTE</span>'}
            </td>
            <td><span class="badge ${badgeClass}">${l.statusVisual}</span></td>
            <td class="col-actions">
                <div class="actions-cell">
                    <button class="btn btn-sm" style="${l.pago ? 'background:var(--border); color:var(--text-light)' : 'background:#10b981; color:white'}" onclick="alternarPagamento(${l.id})">
                        <i class="bi bi-currency-dollar"></i>
                    </button>
                    <button class="btn btn-sm" style="background:#25D366; color:white" onclick="enviarZap(${l.id})">
                        <i class="bi bi-whatsapp"></i>
                    </button>
                    <button class="btn btn-sm btn-warning" style="color:white" onclick="gerarRomaneio(${l.id})">
                        <i class="bi bi-truck"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="gerarRelatorio(${l.id})">
                        <i class="bi bi-file-text"></i>
                    </button>
                    ${l.status !== 'devolvido' ? `<button class="btn btn-sm btn-danger" onclick="cancelarLocacao(${l.id})"><i class="bi bi-trash"></i></button>` : ''}
                </div>
            </td>
        `;
        fragment.appendChild(tr);
    });
    
    tbody.innerHTML = '';
    tbody.appendChild(fragment); // üöÄ 1 reflow ao inv√©s de 50+
    
    criarControlesPaginacao('locacoes', totalPaginas, filtrados.length);
}
        
// === CRIAR BOT√ïES DE PAGINA√á√ÉO ===
function criarControlesPaginacao(tipo, totalPaginas, totalItens) {
    if (totalPaginas <= 1) return; // N√£o precisa de pagina√ß√£o
    
    const tbody = document.getElementById(`tbl${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    if (!tbody) return;
    
    const paginaAtualTipo = paginaAtual[tipo];
    
    const controles = `
        <tr style="background: var(--surface-hover);">
            <td colspan="10" style="text-align: center; padding: 15px;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <button class="btn btn-sm btn-secondary" onclick="irParaPagina('${tipo}', ${paginaAtualTipo - 1})" ${paginaAtualTipo === 1 ? 'disabled' : ''}>
                        <i class="bi bi-chevron-left"></i> Anterior
                    </button>
                    <span style="font-weight: 600; color: var(--text);">
                        P√°gina ${paginaAtualTipo} de ${totalPaginas} 
                        <span style="opacity: 0.6; font-size: 0.85rem;">(${totalItens} itens)</span>
                    </span>
                    <button class="btn btn-sm btn-secondary" onclick="irParaPagina('${tipo}', ${paginaAtualTipo + 1})" ${paginaAtualTipo === totalPaginas ? 'disabled' : ''}>
                        Pr√≥xima <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
    
    tbody.insertAdjacentHTML('beforeend', controles);
}

// === NAVEGA√á√ÉO DE P√ÅGINAS ===
function irParaPagina(tipo, novaPagina) {
    paginaAtual[tipo] = novaPagina;
    
    if (tipo === 'locacoes') renderLocacoes();
    if (tipo === 'pecas') renderEstoque();
    if (tipo === 'locadores') renderLocadores();
}


    // ========================================
// üî• RENDERIZAR LOCADORES OTIMIZADA
// ========================================
function renderLocadores() {
    const termo = (DOM.get('buscaCliente')?.value || '').toLowerCase();
    const tbody = DOM.get('tblLocadores');
    if (!tbody) return;
    
    const clientesFiltrados = locadores.filter(c => 
        c.nome.toLowerCase().includes(termo) || 
        (c.documento && c.documento.toLowerCase().includes(termo))
    );
    
    if (clientesFiltrados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px; opacity:0.6;">Nenhum cliente encontrado.</td></tr>';
        return;
    }
    
    // üî• OTIMIZA√á√ÉO: DocumentFragment
    const fragment = document.createDocumentFragment();
    
    clientesFiltrados.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <div style="font-weight:600">${c.nome}</div>
                <div style="font-size:0.75rem; opacity:0.7;">${c.documento || ''}</div>
            </td>
            <td>${c.email || '-'}</td>
            <td>${c.telefone || '-'}</td>
            <td class="col-actions">
                <div class="actions-cell">
                    <button class="btn btn-sm btn-info" onclick="abrirEditarLocador(${c.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="gerarRelatorioAnual(${c.id})">
                        <i class="bi bi-file-text"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="removerItem('locadores', ${c.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;
        fragment.appendChild(tr);
    });
    
    tbody.innerHTML = '';
    tbody.appendChild(fragment);
}

   // ========================================
// üî• RENDERIZAR ESTOQUE OTIMIZADA
// ========================================
// --- RENDERIZAR ESTOQUE (COM BUSCA INTELIGENTE) ---
function renderEstoque() {
  const termoRaw = DOM.get('buscaEstoque')?.value || '';
  
  // Fun√ß√£o interna para limpar acentos (Ex: 'N√£o' vira 'nao')
  const normalizar = (t) => t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
  
  const termo = normalizar(termoRaw);
  const tbody = DOM.get('tblEstoque');
  if (!tbody) return;

  const itensFiltrados = pecas.filter(p => {
    // 1. Pega os dados do item
    const nome = normalizar(p.nome || '');
    const codigo = normalizar(p.codigo || '');
    const medida = normalizar(p.medida || '');

    // 2. Pega o nome da Categoria (Tipo) para pesquisar tamb√©m
    const tipo = tipos.find(t => t.id === p.tipoId);
    const categoria = tipo ? normalizar(tipo.nome) : '';

    // 3. Verifica se o termo pesquisado est√° em QUALQUER um desses lugares
    return nome.includes(termo) || 
           codigo.includes(termo) || 
           categoria.includes(termo) ||
           medida.includes(termo);
  });

  // Se n√£o encontrar nada
  if (itensFiltrados.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:30px; opacity:0.6;">Nenhum item encontrado para "${termoRaw}".</td></tr>`;
    return;
  }

  const fragment = document.createDocumentFragment();

  itensFiltrados.forEach(p => {
    const tipo = tipos.find(x => x.id === p.tipoId);

    const thumb = p.foto
      ? `<img src="${p.foto}" style="width:36px; height:36px; object-fit:cover; border-radius:6px;">`
      : `<div style="width:36px; height:36px; background:var(--border); border-radius:6px; display:flex; align-items:center; justify-content:center;"><i class="bi bi-box" style="opacity:0.5;"></i></div>`;

    let corEstoque =
      p.disponivel === 0 ? 'color:#ef4444; font-weight:bold;' :
      p.disponivel <= 3 ? 'color:#f59e0b; font-weight:bold;' : '';

    const marcado = (typeof estoqueSelecionados !== 'undefined' && estoqueSelecionados.has(p.id)) ? 'checked' : '';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="width:40px;">
        <input class="chk-estoque" type="checkbox" data-id="${p.id}" ${marcado}
               onchange="onSelectEstoque(${p.id}, this.checked)">
      </td>
      <td>${thumb}</td>
      <td><span style="font-family:monospace; font-weight:600; color:var(--text-light);">${p.codigo}</span></td>
      <td>${tipo ? tipo.nome : '-'}</td>
      <td>
        <div style="font-weight:600">${p.nome}</div>
        <div style="font-size:0.75rem; opacity:0.7;">${p.medida || ''}</div>
      </td>
      <td>R$ ${Number(p.valor || 0).toFixed(2)}</td>
      <td>
        <span style="${corEstoque}">${p.disponivel}</span>
        <span style="opacity:0.5; font-size:0.75rem;">/ ${p.quantidade}</span>
      </td>
      <td class="col-actions">
        <div class="actions-cell">
          <button class="btn btn-sm btn-info" onclick="abrirEditarPeca(${p.id})"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-danger" onclick="removerItem('pecas', ${p.id})"><i class="bi bi-trash"></i></button>
        </div>
      </td>
    `;

    fragment.appendChild(tr);
  });

  tbody.innerHTML = '';
  tbody.appendChild(fragment);
}

    // --- DEVOLU√á√ïES (RECOLOCAR) ---
function renderDevolucoes() {
    const tbody = document.getElementById('tblDevolucoes'); 
    if(!tbody) return;
    
    // Pega as √∫ltimas 20 devolu√ß√µes
    const lista = devolucoes.slice().reverse().slice(0, 20);
    
    tbody.innerHTML = lista.map(d => {
        const l = locacoes.find(x => x.id === d.locacaoId);
        // Tenta achar o cliente no contrato ou usa ID 0
        const c = locadores.find(x => x.id === (l ? l.locadorId : 0));
        
        return `<tr>
            <td><div style="font-weight:600;">${c ? c.nome : '-'}</div></td>
            <td>${formatarData(d.dataDevolucao)}</td>
            <td><span class="badge badge-success">Conclu√≠do</span></td>
            <td class="col-actions">
                <button class="btn btn-sm btn-secondary" onclick="gerarRecibo(${l ? l.id : 0})">
                    <i class="bi bi-printer"></i>
                </button>
            </td>
        </tr>`;
    }).join('');
}

// --- TIPOS (RECOLOCAR) ---
function renderTipos() {
    const tbody = document.getElementById('tblTipos');
    if(!tbody) return;
    
    tbody.innerHTML = tipos.map(t => `
        <tr>
            <td><b>${t.nome}</b></td>
            <td>${t.desc || '-'}</td>
            <td class="col-actions">
                <div class="actions-cell">
                    <button class="btn btn-sm btn-info" onclick="abrirEditarTipo(${t.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// --- FUN√á√ÉO GERAL (CASO FALTE) ---
function renderTudo() {
    if(typeof renderLocacoes === 'function') renderLocacoes();
    if(typeof renderLocadores === 'function') renderLocadores();
    if(typeof renderEstoque === 'function') renderEstoque();
    if(typeof renderDevolucoes === 'function') renderDevolucoes();
    if(typeof renderTipos === 'function') renderTipos();
    if(typeof renderStats === 'function') renderStats();
}

    function renderStats() {
        const elC = document.getElementById('dashClientes');
        if(elC) elC.innerText = locadores.length;
        const ativas = locacoes.filter(l => l.status === 'ativo');
        const elL = document.getElementById('dashLocacoes'); if(elL) elL.innerText = ativas.length;
        let totalRecebido = 0, totalPendente = 0;
        ativas.forEach(loc => {
            let subtotal = 0; (loc.items || []).forEach(i => subtotal += (parseFloat(i.valor||0) * parseInt(i.quantidade||1)));
            let div = parseFloat(loc.divisorFatura || 1); if(div <= 0) div = 1;
            let vf = subtotal / div;
            if (loc.pago) totalRecebido += vf; else totalPendente += vf;
        });
        const elF = document.getElementById('dashFaturamento');
        if(elF) elF.innerHTML = `<span style="color:var(--primary)">R$ ${totalRecebido.toLocaleString('pt-BR',{minimumFractionDigits:0})}</span><br><span style="font-size:0.8rem; color:var(--text-light); font-weight:400;">+ R$ ${totalPendente.toLocaleString('pt-BR',{minimumFractionDigits:0})} pendente</span>`;
        const hoje = new Date(); hoje.setHours(0,0,0,0);
        let atrasados = 0;
        let proximas = [];
        ativas.forEach(loc => {
            if(loc.dataDevolucaoPrevisao) {
                const d = new Date(loc.dataDevolucaoPrevisao); d.setHours(0,0,0,0);
                if (d < hoje) atrasados++;
                if (d >= hoje) proximas.push({ data: d, cliente: locadores.find(c => c.id === loc.locadorId)?.nome || '?' });
            }
        });
        const elA = document.getElementById('dashAtrasos'); if(elA) { elA.innerText = atrasados; elA.style.color = atrasados > 0 ? '#ef4444' : 'var(--text)'; }
        
        proximas.sort((a,b) => a.data - b.data);
        const tblDash = document.getElementById('tblDashDevolucoes');
        if(tblDash) {
            if(!proximas.length) tblDash.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:15px; opacity:0.6;">Nada previsto.</td></tr>';
            else tblDash.innerHTML = proximas.slice(0, 5).map(p => `<tr><td>${p.data.toLocaleDateString('pt-BR')}</td><td>${p.cliente}</td><td style="text-align:center"><span class="badge badge-info">AGENDADO</span></td></tr>`).join('');
        }
    }

    function updateSelects() { 
        const c = document.getElementById('aluguelCliente');
        if(c) c.innerHTML='<option value="">Selecione...</option>'+locadores.map(x=>`<option value="${x.id}">${x.nome}</option>`).join(''); 
        
        const i = document.getElementById('aluguelItemSelect'); 
        if(i) i.innerHTML='<option value="">Selecione...</option>'+pecas.map(x=>`<option value="${x.id}">${x.nome} (${x.disponivel} disp)</option>`).join(''); 
        
        const d = document.getElementById('devLocacao');
        if(d) d.innerHTML='<option value="">Selecione...</option>'+locacoes.filter(l=>l.status!=='devolvido').map(l=>`<option value="${l.id}">#${l.id.toString().slice(-4)} - ${locadores.find(x=>x.id==l.locadorId)?.nome}</option>`).join(''); 
        
        const tOpts = '<option value="0">Geral</option>'+tipos.map(x=>`<option value="${x.id}">${x.nome}</option>`).join('');
        
        const t = document.getElementById('pecaTipo'); 
        if(t) t.innerHTML=tOpts;
        const tE = document.getElementById('editPecaTipo'); 
        if(tE) tE.innerHTML=tOpts;
    } 

    // --- L√ìGICA E FUN√á√ïES GERAIS ---
    function mostrarToast(m,t) { const x=document.getElementById("toast");
    x.innerText=m; x.style.background=t==='erro'?'#ef4444':'#1f2937'; x.className="show"; setTimeout(()=>x.className="",3000); }
    
    function addItemCarrinho() { 
        // 1. Pega o item selecionado
        var select = document.getElementById('aluguelItemSelect');
        var id = select.value;
        if (!id) return; 
        
        // 2. Trata a quantidade com seguran√ßa
        var qtdInput = document.getElementById('aluguelQtd').value;
        var qtd = parseInt(qtdInput);
        if (isNaN(qtd) || qtd < 1) qtd = 1;

        // 3. Busca a pe√ßa no banco de dados
        var p = pecas.find(function(x) { return x.id == id; });
        if (!p) return;

        // --- TRAVA DE ESTOQUE (NOVO) ---
        // Verifica se j√° tem esse item no carrinho para somar
        var itemNoCarrinho = carrinhoLocacao.find(x => x.pecaId == p.id);
        var qtdJaNoCarrinho = itemNoCarrinho ? itemNoCarrinho.quantidade : 0;
        
        var qtdTotalSolicitada = qtd + qtdJaNoCarrinho;

        if (qtdTotalSolicitada > p.disponivel) {
            return mostrarToast(`Estoque insuficiente! S√≥ restam ${p.disponivel} unidades.`, "erro");
        }
        // -------------------------------

        // 4. Adiciona ou Atualiza o carrinho
        if (itemNoCarrinho) {
            itemNoCarrinho.quantidade += qtd; // Se j√° existe, s√≥ aumenta a quantidade
        } else {
            carrinhoLocacao.push({
                pecaId: p.id, 
                nome: p.nome, 
                valor: parseFloat(p.valor), 
                quantidade: qtd
            });
        }
        
        // 5. Gera o HTML da lista
        var htmlLista = '';
        for (var i = 0; i < carrinhoLocacao.length; i++) {
            var item = carrinhoLocacao[i];
            var totalItem = (item.valor * item.quantidade).toFixed(2);
            
            htmlLista += '<div class="item-carrinho">';
            htmlLista += '<span><b>' + item.quantidade + 'x</b> ' + item.nome + '</span>';
            htmlLista += '<span style="font-weight:600">R$ ' + totalItem + '</span>';
            htmlLista += '</div>';
        }

        // 6. Atualiza a tela
        document.getElementById('carrinhoList').innerHTML = htmlLista;
        mostrarToast("Item adicionado!");
    }
    
function finalizarLocacao() { 
    var cli = document.getElementById('aluguelCliente').value;
    var ini = document.getElementById('aluguelIni').value; 
    var fim = document.getElementById('aluguelFim').value;

    // L√ä O DIVISOR DO CAMPO (CORRE√á√ÉO AQUI)
    var divInput = parseFloat(document.getElementById('aluguelDivisor').value);
    if(isNaN(divInput) || divInput <= 0) divInput = 1;

    if (!cli || carrinhoLocacao.length === 0) {
        mostrarToast("Preencha cliente e itens!", "erro");
        return;
    }
    
    var itensParaSalvar = [];
    for (var i = 0; i < carrinhoLocacao.length; i++) { 
        itensParaSalvar.push(carrinhoLocacao[i]); 
    }

    locacoes.push({
        id: Date.now(), 
        locadorId: parseInt(cli), 
        dataAluguel: ini, 
        dataDevolucaoPrevisao: fim, 
        items: itensParaSalvar, 
        status: 'ativo', 
        divisorFatura: divInput
    });

    carrinhoLocacao = [];
    document.getElementById('carrinhoList').innerHTML = '<i><i class="bi bi-info-circle"></i> Nenhum item adicionado √† lista.</i>';
    document.getElementById('aluguelCliente').value = ""; 
    document.getElementById('aluguelItemSelect').value = ""; 
    document.getElementById('aluguelQtd').value = "1";
    
    salvarLocal();
    renderTudo();
    
    // Registra no log de auditoria
    const cliente = locadores.find(x => x.id === parseInt(cli));
    registrarLog('locacao', 'criar', `Loca√ß√£o criada: ${cliente?.nome || 'Cliente'} - ${itensParaSalvar.length} itens`);
    
    mostrarToast("Loca√ß√£o Conclu√≠da!");
    sincronizar('salvar');
}

    // === RECALCULAR DISPONIBILIDADE COM CACHE ===
function recalcularDisponibilidade(forcar = false) {
    const agora = Date.now();
    
    // Se j√° calculou h√° menos de 5 segundos, usa o cache
    if (!forcar && cacheDisponibilidade && (agora - ultimaAtualizacaoCache) < 5000) {
        console.log('üì¶ Usando cache de disponibilidade');
        return;
    }
    
    console.log('üîÑ Recalculando disponibilidade...');
    
    // Criar mapa de alugu√©is ativos para busca O(1) ao inv√©s de O(n)
    const aluguelPorPeca = new Map();
    
    locacoes.forEach(l => {
        if (l.status !== 'devolvido') {
            l.items.forEach(i => {
                const qtdAlugada = (i.quantidade || 0) - (i.devolvidos || 0);
                const atual = aluguelPorPeca.get(i.pecaId) || 0;
                aluguelPorPeca.set(i.pecaId, atual + qtdAlugada);
            });
        }
    });
    
    // Atualizar disponibilidade de cada pe√ßa
    pecas.forEach(p => {
        const alugado = aluguelPorPeca.get(p.id) || 0;
        p.disponivel = (p.quantidade || 0) - alugado;
    });
    
    // Atualizar cache
    cacheDisponibilidade = true;
    ultimaAtualizacaoCache = agora;
    
    console.log('‚úÖ Disponibilidade recalculada');
}


    function salvarLocador() { const n=document.getElementById('locNome').value; if(!n) return; locadores.push({id:Date.now(), nome:n, email:document.getElementById('locEmail').value, telefone:document.getElementById('locTel').value, documento:document.getElementById('locDoc').value}); salvarLocal(); renderTudo(); sincronizar('salvar'); document.getElementById('locNome').value=""; mostrarToast("Cliente Salvo!"); }
    
    function salvarPeca() { const n=document.getElementById('pecaNome').value; if(!n) return; pecas.push({id:Date.now(), nome:n, codigo:document.getElementById('pecaCod').value, valor:parseFloat(document.getElementById('pecaValor').value), quantidade:parseInt(document.getElementById('pecaQtd').value), disponivel:parseInt(document.getElementById('pecaQtd').value), tipoId:parseInt(document.getElementById('pecaTipo').value), medida:document.getElementById('pecaMedida').value}); salvarLocal(); renderTudo(); sincronizar('salvar'); document.getElementById('pecaNome').value=""; mostrarToast("Item Salvo!"); }
    
    function salvarTipo() { const n=document.getElementById('tipoNome').value; if(!n) return; tipos.push({id:Date.now(), nome:n, desc:document.getElementById('tipoDesc').value}); salvarLocal(); renderTudo(); sincronizar('salvar'); document.getElementById('tipoNome').value=""; mostrarToast("Tipo Salvo!"); }

    function removerItem(t, id) {
    if(!confirm("Tem certeza?")) return;
    
    if(t === 'locadores') {
        const item = locadores.find(x => x.id == id);
        locadores = locadores.filter(x => x.id !== id);
        registrarLog('cliente', 'deletar', `Cliente removido: ${item?.nome || 'ID:'+id}`);
    }
    if(t === 'pecas') {
        const item = pecas.find(x => x.id == id);
        pecas = pecas.filter(x => x.id !== id);
        registrarLog('item', 'deletar', `Item removido: ${item?.nome || 'ID:'+id}`);
    }
    if(t === 'tipos') {
        const item = tipos.find(x => x.id == id);
        tipos = tipos.filter(x => x.id !== id);
        registrarLog('item', 'deletar', `Tipo removido: ${item?.nome || 'ID:'+id}`);
    }
    
    salvarLocal();
    renderTudo();
    sincronizar('salvar');
}

    function cancelarLocacao(id) { if(!confirm("Cancelar loca√ß√£o?")) return; locacoes=locacoes.filter(l=>l.id!==id); salvarLocal(); renderTudo(); sincronizar('salvar'); }
    function mudarFiltro(n) { filtroAtual = n; renderLocacoes(); }
    function irParaLocacoes(f) { abrirTab('locacoes'); setTimeout(() => mudarFiltro(f), 100); }
    function alternarPagamento(id) { const l = locacoes.find(x => x.id == id); if(l) { l.pago = !l.pago; salvarLocal(); renderLocacoes(); renderStats(); sincronizar('salvar'); mostrarToast("Pagamento atualizado!"); } }

    // --- AUTENTICA√á√ÉO E SYNC ---
    function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: 'https://www.googleapis.com/auth/drive.file', callback: (resp) => { if(resp.error) return alert(JSON.stringify(resp)); localStorage.setItem('gToken', resp.access_token); entrarApp(); sincronizar('carregar'); } }); }
    function fazerLoginGoogle() { if(tokenClient) tokenClient.requestAccessToken({prompt: 'consent'}); else if(window.google) gisLoaded(); }
    function entrarOffline() { entrarApp(); document.getElementById('syncText').innerText="Offline"; document.getElementById('syncBadge').className="sync-badge sync-offline"; }
    function entrarApp() { document.getElementById('loginArea').style.display='none'; document.getElementById('appArea').style.display='block'; renderTudo(); }
    function sair() { localStorage.removeItem('gToken'); location.reload(); }
    
    // === SISTEMA DE SINCRONIZA√á√ÉO SEGURA V2 ===

// Backup de emerg√™ncia antes de sobrescrever dados
function criarBackupEmergencia() {
    const timestamp = new Date().toISOString();
    const backup = {
        data: timestamp,
        locadores, pecas, locacoes, devolucoes, tipos, config
    };
    localStorage.setItem('mtzBackupEmergencia', JSON.stringify(backup));
    console.log('‚úÖ Backup de emerg√™ncia criado:', timestamp);
    return backup;
}

// Sincroniza√ß√£o com prote√ß√£o contra perda de dados
async function sincronizar(modo) {
    if (!navigator.onLine) {
        updStatus('offline');
        return;
    }

    updStatus('saving');

    try {
        if (modo === 'carregar') {
            // Carregar dados da nuvem
            const response = await fetch(`${API_URL}?action=carregar`);
            const texto = await response.text();

            // Valida√ß√£o de resposta
            if (texto.startsWith('<')) {
                console.warn('‚ö†Ô∏è Resposta inv√°lida do servidor');
                updStatus('offline');
                return;
            }

            const dadosNuvem = JSON.parse(texto);

            // Verificar se h√° dados locais
            const temDadosLocais = locadores.length > 0 || pecas.length > 0 || locacoes.length > 0;

            if (temDadosLocais) {
                // Detectar conflito de timestamps
                const timestampLocal = localStorage.getItem('mtzUltimaEdicao') || 0;
                const timestampNuvem = dadosNuvem.ultimaEdicao || 0;

                console.log('üìÖ Local:', new Date(Number(timestampLocal)).toLocaleString());
                console.log('‚òÅÔ∏è Nuvem:', new Date(Number(timestampNuvem)).toLocaleString());

                // Se nuvem for mais recente, perguntar
                if (timestampNuvem > timestampLocal) {
                    const confirmar = confirm(
                        '‚ö†Ô∏è ATEN√á√ÉO: Dados na nuvem s√£o mais recentes!\n\n' +
                        `üìÖ Seus dados locais: ${new Date(Number(timestampLocal)).toLocaleString()}\n` +
                        `‚òÅÔ∏è Dados na nuvem: ${new Date(Number(timestampNuvem)).toLocaleString()}\n\n` +
                        '‚úÖ Clique OK para CARREGAR da nuvem (backup autom√°tico ser√° criado)\n' +
                        '‚ùå Clique CANCELAR para manter seus dados locais'
                    );

                    if (!confirmar) {
                        console.log('üö´ Usu√°rio cancelou sincroniza√ß√£o');
                        updStatus('offline');
                        mostrarToast('Sincroniza√ß√£o cancelada. Dados locais mantidos.');
                        return;
                    }

                    // Criar backup antes de sobrescrever
                    criarBackupEmergencia();
                }
            }

            // Carregar dados
            if (dadosNuvem.locadores) {
                locadores = dadosNuvem.locadores || [];
                pecas = dadosNuvem.pecas || [];
                locacoes = dadosNuvem.locacoes || [];
                devolucoes = dadosNuvem.devolucoes || [];
                tipos = dadosNuvem.tipos || [];
                config = dadosNuvem.config || config;

                salvarLocal();
                renderTudo();
                mostrarToast('‚úÖ Dados carregados da nuvem!');
            }

        } else {
            // Enviar dados para nuvem
            const timestamp = Date.now();
            const dadosParaEnviar = {
                locadores, pecas, locacoes, devolucoes, tipos, config,
                ultimaEdicao: timestamp
            };

            localStorage.setItem('mtzUltimaEdicao', timestamp.toString());

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    dados: JSON.stringify(dadosParaEnviar)
                })
            });

            if (response.ok) {
                mostrarToast('‚òÅÔ∏è Dados salvos na nuvem!');
                console.log('‚úÖ Sincroniza√ß√£o conclu√≠da:', new Date(timestamp).toLocaleString());
            }
        }

        updStatus('online');

    } catch (erro) {
        console.error('‚ùå Erro na sincroniza√ß√£o:', erro);
        updStatus('offline');
        mostrarToast('‚ö†Ô∏è Erro ao sincronizar. Dados salvos localmente.');
    }
}

// Backup autom√°tico di√°rio
function iniciarBackupAutomatico() {
    const ultimoBackup = localStorage.getItem('mtzUltimoBackupAuto');
    const agora = Date.now();
    const umDia = 24 * 60 * 60 * 1000;

    if (!ultimoBackup || (agora - Number(ultimoBackup)) > umDia) {
        const backup = {
            data: new Date().toISOString(),
            versao: 'V11',
            locadores, pecas, locacoes, devolucoes, tipos, config
        };

        localStorage.setItem('mtzBackupAutomatico', JSON.stringify(backup));
        localStorage.setItem('mtzUltimoBackupAuto', agora.toString());
        
        console.log('üíæ Backup autom√°tico criado:', new Date().toLocaleString());
    }
}

// Restaurar backup de emerg√™ncia
function restaurarBackupEmergencia() {
    const backup = localStorage.getItem('mtzBackupEmergencia');
    if (!backup) {
        alert('‚ùå Nenhum backup de emerg√™ncia encontrado.');
        return;
    }

    const confirmar = confirm(
        '‚ö†Ô∏è Deseja restaurar o BACKUP DE EMERG√äNCIA?\n\n' +
        'Isso ir√° substituir todos os dados atuais.'
    );

    if (confirmar) {
        const dados = JSON.parse(backup);
        locadores = dados.locadores || [];
        pecas = dados.pecas || [];
        locacoes = dados.locacoes || [];
        devolucoes = dados.devolucoes || [];
        tipos = dados.tipos || [];
        config = dados.config || config;

        salvarLocal();
        renderTudo();
        mostrarToast('‚úÖ Backup de emerg√™ncia restaurado!');
        console.log('‚úÖ Dados restaurados de:', dados.data);
    }
}

// Ver informa√ß√µes de backup
function verInfoBackup() {
    const backup = localStorage.getItem('mtzBackupEmergencia');
    const backupAuto = localStorage.getItem('mtzBackupAutomatico');
    
    let msg = 'üìä INFORMA√á√ïES DE BACKUP\n\n';
    
    if (backup) {
        const dados = JSON.parse(backup);
        msg += `üÜò Backup de Emerg√™ncia:\n`;
        msg += `   Data: ${new Date(dados.data).toLocaleString()}\n`;
        msg += `   Registros: ${dados.locadores?.length || 0} clientes, ${dados.locacoes?.length || 0} loca√ß√µes\n\n`;
    } else {
        msg += '‚ùå Nenhum backup de emerg√™ncia\n\n';
    }
    
    if (backupAuto) {
        const dados = JSON.parse(backupAuto);
        msg += `üíæ Backup Autom√°tico:\n`;
        msg += `   Data: ${new Date(dados.data).toLocaleString()}\n`;
    } else {
        msg += '‚ùå Nenhum backup autom√°tico';
    }
    
    alert(msg);
}

    
    // === SALVAR COM PROTE√á√ÉO CONTRA ESTOURO ===
function salvarLocal() {
    cacheDisponibilidade = null;
    try {
        const dados = {
    versao: '11.0',
    data: new Date().toISOString(),
    locadores, pecas, locacoes, devolucoes, tipos, config,
    logsAuditoria  // ‚Üê ADICIONE ESTA LINHA
};

        const json = JSON.stringify(dados);
        const tamanhoKB = (new Blob([json]).size / 1024).toFixed(2);
        const tamanhoMB = (tamanhoKB / 1024).toFixed(2);

        console.log(`üíæ Salvando ${tamanhoKB} KB no localStorage...`);

        // Verificar se est√° pr√≥ximo do limite (5MB = 5120 KB)
        if (parseFloat(tamanhoKB) > 4500) {
            console.warn(`‚ö†Ô∏è ALERTA: LocalStorage usando ${tamanhoMB} MB de 5 MB!`);
            mostrarToast(`‚ö†Ô∏è Armazenamento em ${Math.round((tamanhoKB/5120)*100)}%! Fa√ßa backup e arquive dados antigos.`, 'erro');
        }

        localStorage.setItem('mtzBackup', json);
        return true;

    } catch (erro) {
        console.error('‚ùå Erro ao salvar:', erro);

        if (erro.name === 'QuotaExceededError') {
            alert(
                'üî¥ ERRO CR√çTICO: LocalStorage cheio!\n\n' +
                'O sistema n√£o pode salvar mais dados.\n\n' +
                'SOLU√á√ïES:\n' +
                '1. V√° em Config ‚Üí Baixar JSON (fazer backup)\n' +
                '2. Depois v√° em Config ‚Üí Arquivar (Limpeza)\n' +
                '3. Ou delete loca√ß√µes antigas manualmente\n\n' +
                '‚ö†Ô∏è Novos dados N√ÉO ser√£o salvos at√© liberar espa√ßo!'
            );
            return false;
        }

        // Outros erros
        alert('‚ùå Erro ao salvar dados: ' + erro.message);
        return false;
    }
}

    // === CARREGAR COM VALIDA√á√ÉO E RECUPERA√á√ÉO ===
function carregarLocal() {
    try {
        const json = localStorage.getItem('mtzBackup');
        
        if (!json) {
            console.log('üì≠ Nenhum dado local encontrado (primeira vez)');
            return;
        }

        const dados = JSON.parse(json);

        // Valida√ß√£o de integridade
        if (!dados.locadores || !Array.isArray(dados.locadores)) {
            throw new Error('Dados corrompidos: estrutura inv√°lida');
        }

        // Carregar dados
        locadores = dados.locadores || [];
        pecas = dados.pecas || [];
        locacoes = dados.locacoes || [];
        devolucoes = dados.devolucoes || [];
        tipos = dados.tipos || [];
        config = dados.config || config;
        logsAuditoria = dados.logsAuditoria || [];


        const tamanhoKB = (new Blob([json]).size / 1024).toFixed(2);
        
        console.log('‚úÖ Dados locais carregados:', {
            tamanho: `${tamanhoKB} KB`,
            clientes: locadores.length,
            itens: pecas.length,
            locacoes: locacoes.length,
            versao: dados.versao || 'antiga'
        });

        // Alerta se estiver usando mais de 80% do storage
        if (parseFloat(tamanhoKB) > 4000) {
            console.warn('‚ö†Ô∏è LocalStorage usando mais de 80%');
        }

    } catch (erro) {
        console.error('‚ùå Erro ao carregar dados:', erro);
        
        // Tentar recuperar backup autom√°tico
        const backupAuto = localStorage.getItem('mtzBackupAutomatico');
        const backupEmergencia = localStorage.getItem('mtzBackupEmergencia');
        
        if (backupEmergencia || backupAuto) {
            const restaurar = confirm(
                '‚ö†Ô∏è ERRO ao carregar dados locais!\n\n' +
                'Poss√≠vel corrup√ß√£o detectada.\n\n' +
                '‚úÖ Backups dispon√≠veis encontrados!\n\n' +
                'Deseja tentar restaurar automaticamente?'
            );

            if (restaurar) {
                tentarRecuperacaoAutomatica();
            }
        } else {
            alert(
                'üî¥ ERRO CR√çTICO: Dados corrompidos e sem backup!\n\n' +
                'Causas poss√≠veis:\n' +
                '- Fechamento abrupto do navegador\n' +
                '- Falta de espa√ßo no disco\n' +
                '- Extens√£o do navegador interferindo\n\n' +
                'O sistema ser√° reiniciado vazio.'
            );
            
            // Resetar para dados vazios
            locadores = [];
            pecas = [];
            locacoes = [];
            devolucoes = [];
            tipos = [];
        }
    }
}

// === RECUPERA√á√ÉO AUTOM√ÅTICA ===
function tentarRecuperacaoAutomatica() {
    try {
        // Tentar backup de emerg√™ncia primeiro
        let backup = localStorage.getItem('mtzBackupEmergencia');
        let fonte = 'Emerg√™ncia';
        
        // Se n√£o tiver, tentar backup autom√°tico
        if (!backup) {
            backup = localStorage.getItem('mtzBackupAutomatico');
            fonte = 'Autom√°tico';
        }
        
        if (!backup) {
            throw new Error('Nenhum backup dispon√≠vel');
        }

        const dados = JSON.parse(backup);
        
        locadores = dados.locadores || [];
        pecas = dados.pecas || [];
        locacoes = dados.locacoes || [];
        devolucoes = dados.devolucoes || [];
        tipos = dados.tipos || [];
        config = dados.config || config;

        salvarLocal();
        renderTudo();
        
        alert(
            `‚úÖ RECUPERA√á√ÉO BEM-SUCEDIDA!\n\n` +
            `Fonte: Backup ${fonte}\n` +
            `Data: ${new Date(dados.data).toLocaleString()}\n\n` +
            `Registros recuperados:\n` +
            `- ${locadores.length} clientes\n` +
            `- ${pecas.length} itens\n` +
            `- ${locacoes.length} loca√ß√µes\n\n` +
            `üí° Recomenda√ß√£o: Fa√ßa um backup JSON agora!`
        );
        
        console.log('‚úÖ Dados recuperados de:', dados.data);
        
    } catch (erro) {
        alert('‚ùå Falha na recupera√ß√£o autom√°tica: ' + erro.message);
    }
}

    function updStatus(s) { const b=document.getElementById('syncBadge'), t=document.getElementById('syncText'); if(s==='online'){b.className="sync-badge sync-online";t.innerText="Online";} else if(s==='saving'){b.className="sync-badge sync-saving";t.innerText="Salvando...";} else {b.className="sync-badge sync-offline";t.innerText="Offline";} }

    // --- FUN√á√ïES DE EDI√á√ÉO ---
    function abrirEditarLocador(id) { const c = locadores.find(x => x.id === id); if(!c) return; document.getElementById('editLocId').value = c.id; document.getElementById('editLocNome').value = c.nome; document.getElementById('editLocEmail').value = c.email || ''; document.getElementById('editLocTel').value = c.telefone || ''; document.getElementById('modalEditarLocador').classList.add('active'); }
    function salvarEdicaoLocador() { const id = parseInt(document.getElementById('editLocId').value); const c = locadores.find(x => x.id === id); if(c) { c.nome = document.getElementById('editLocNome').value; c.email = document.getElementById('editLocEmail').value; c.telefone = document.getElementById('editLocTel').value; salvarLocal(); renderTudo(); sincronizar('salvar'); document.getElementById('modalEditarLocador').classList.remove('active');registrarLog('cliente', 'criar', `Cliente cadastrado: ${nome}`);registrarLog('cliente', 'criar', `Cliente cadastrado: ${nome}`); mostrarToast("Cliente atualizado!"); } }
    
    function abrirEditarTipo(id) { const t = tipos.find(x => x.id === id); if(!t) return; document.getElementById('editTipoId').value = t.id; document.getElementById('editTipoNome').value = t.nome; document.getElementById('editTipoDesc').value = t.desc || ''; document.getElementById('modalEditarTipo').classList.add('active'); }
    function salvarEdicaoTipo() { const id = parseInt(document.getElementById('editTipoId').value); const t = tipos.find(x => x.id === id); if(t) { t.nome = document.getElementById('editTipoNome').value; t.desc = document.getElementById('editTipoDesc').value; salvarLocal(); renderTudo(); sincronizar('salvar'); document.getElementById('modalEditarTipo').classList.remove('active'); mostrarToast("Tipo atualizado!"); } }

    function abrirEditarPeca(id) { const p = pecas.find(x => x.id === id); if(!p) return; document.getElementById('editPecaId').value = p.id; document.getElementById('editPecaCod').value = p.codigo; document.getElementById('editPecaNome').value = p.nome; document.getElementById('editPecaValor').value = p.valor; document.getElementById('editPecaQtd').value = p.quantidade; updateSelects(); const sel = document.getElementById('editPecaTipo'); if(sel) sel.value = p.tipoId || 0; document.getElementById('modalEditarPeca').classList.add('active'); }
    function salvarEdicaoPeca() { const id = parseInt(document.getElementById('editPecaId').value); const p = pecas.find(x => x.id === id); if(p) { const novaQtd = parseInt(document.getElementById('editPecaQtd').value); const diff = novaQtd - (p.quantidade || 0); p.codigo = document.getElementById('editPecaCod').value; p.nome = document.getElementById('editPecaNome').value; p.valor = parseFloat(document.getElementById('editPecaValor').value); p.tipoId = parseInt(document.getElementById('editPecaTipo').value); p.quantidade = novaQtd; p.disponivel = (p.disponivel || 0) + diff; salvarLocal(); renderTudo(); sincronizar('salvar'); document.getElementById('modalEditarPeca').classList.remove('active'); registrarLog('item', 'editar', `Item atualizado: ${p.nome}`); mostrarToast("Item atualizado!"); } }

    function salvarConfig() { const elRodape = document.getElementById('confRodape'); const elTel = document.getElementById('confTel'); const elEmail = document.getElementById('confEmail'); if(elRodape) config.rodape = elRodape.value; if(elTel) config.tel = elTel.value; if(elEmail) config.email = elEmail.value; salvarLocal(); sincronizar('salvar'); mostrarToast("Config salva!"); }
    // --- EXCEL INTELIGENTE (COM PROTE√á√ÉO CONTRA LISTA VAZIA) ---
    function processarExcelInteligente(input) {
        if(!input.files || !input.files[0]) return;
        
        // --- PROTE√á√ÉO DE SEGURAN√áA (Adicione isso!) ---
        // Se as listas sumiram ao apagar tudo, recria elas como vazias agora.
        if (typeof pecas === 'undefined' || !Array.isArray(pecas)) pecas = [];
        if (typeof tipos === 'undefined' || !Array.isArray(tipos)) tipos = [];
        // --------------------------------------------------

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                // 1. Configura√ß√£o Inicial
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheet];
                
                const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                if(!rows.length) return;
                if(!confirm(`Deseja importar ${rows.length} linhas?`)) return;

                // 2. Vari√°veis de Controle
                let stats = { importados: 0, categorias: 0 };
                let catAtualId = garantirCategoriaGeral();

                // 3. Processamento Linha a Linha
                rows.forEach(row => {
                    if (!row || row.length === 0) return;
                    
                    const dados = {
                        nome: row[0] ? String(row[0]).trim() : "",
                        colAno: row[1], 
                        colQtd: row[3]  
                    };

                    if (ehCabecalhoCategoria(dados)) {
                        catAtualId = definirOuCriarCategoria(dados.nome);
                        return; 
                    }

                    if (ehItemValido(dados)) {
                        const nomeFormatado = aplicarRegraMedidas(dados.nome);
                        const quantidade = definirQuantidade(dados);
                        
                        cadastrarItemSeNovo(nomeFormatado, quantidade, catAtualId);
                    }
                });

                // 4. Finaliza
                finalizarImportacao(stats);

            } catch(err) { 
                console.error(err);
                alert("Erro ao ler Excel: " + err.message);
            }
        };
        reader.readAsArrayBuffer(input.files[0]);

        // ============================================================
        // === FUN√á√ïES AJUDANTES ===
        // ============================================================

        function ehCabecalhoCategoria(d) {
            return d.colAno == 2026 || String(d.colAno).includes("2026");
        }

        function ehItemValido(d) {
            return d.nome && d.nome !== "TOTAL EM METROS";
        }

        function garantirCategoriaGeral() {
            // Prote√ß√£o extra aqui tamb√©m
            if (!Array.isArray(tipos)) tipos = [];
            
            let cat = tipos.find(t => t.nome === "Geral");
            if (!cat) {
                cat = { id: Date.now(), nome: "Geral", desc: "Padr√£o" };
                tipos.push(cat);
            }
            return cat.id;
        }

        function definirOuCriarCategoria(nomeBruto) {
            const nome = nomeBruto.replace(/[\r\n]+/g, "").trim();
            let cat = tipos.find(t => t.nome.toUpperCase() === nome.toUpperCase());
            
            if (!cat) {
                cat = { id: Date.now() + Math.random(), nome: nome, desc: "Importado Excel" };
                tipos.push(cat);
                stats.categorias++;
            }
            return cat.id;
        }

        function aplicarRegraMedidas(nome) {
            if (/^[\d.,]+$/.test(nome)) {
                let valor = parseFloat(nome.replace(',', '.'));
                if (!isNaN(valor)) {
                    if (valor < 1) return Math.round(valor * 100) + 'cm'; 
                    return valor + 'm'; 
                }
            }
            return nome;
        }

        function definirQuantidade(d) {
            let q = parseInt(d.colQtd);       
            if (isNaN(q)) q = parseInt(d.colAno); 
            return isNaN(q) ? 0 : q;
        }

        function cadastrarItemSeNovo(nome, qtd, catId) {
            // Prote√ß√£o extra aqui tamb√©m
            if (!Array.isArray(pecas)) pecas = [];

            const existe = pecas.find(p => p.nome === nome && p.tipoId === catId);

            if (!existe) {
                pecas.push({
                    id: Date.now() + Math.random(),
                    codigo: 'IMP-' + Math.floor(Math.random() * 100000),
                    nome: nome,
                    quantidade: qtd,
                    disponivel: qtd,
                    valor: 0,
                    tipoId: catId,
                    medida: ''
                });
                stats.importados++;
            }
        }

        function finalizarImportacao(s) {
            salvarLocal();
            renderTudo();
            sincronizar('salvar');
            mostrarToast(`Sucesso! ${s.importados} itens importados.`);
        }

    } // <--- FECHAMENTO DA FUN√á√ÉO PRINCIPAL

        function finalizarImportacao(s) {
            salvarLocal();
            renderTudo();
            sincronizar('salvar');
            mostrarToast(`Conclu√≠do! ${s.importados} novos itens em ${s.categorias} novas categorias.`);
        }
    } 
    // ==========================================================
    // FIM DA FUN√á√ÉO (GARANTA QUE ESTA CHAVE } ESTEJA AQUI)
    // ==========================================================
    // --- RELAT√ìRIOS (PDF CLEAN & FULL PAGE CORRIGIDO) ---
    function getHeaderMTZ() {
        return `
        <div style="background:#ffffff; color:#000000; padding:20px; text-align:center; border-bottom: 2px solid #2563eb; margin-bottom: 20px;">
            <img src="./logo.png" alt="MTZ Eventos" style="height: 140px; object-fit: contain;">
        </div>`;
    }
    
    function getFooterMTZ() { 
        return `<div style="position: absolute; bottom: 0; left: 0; width: 100%; background-color: #000000; text-align: center; padding: 15px 0; z-index: 10;"> 
            <div style="color: #ffffff !important; font-size: 10px; font-family: 'Inter', sans-serif;"> 
                ${config.rodape} | ${config.tel} | ${config.email} 
            </div> 
        </div>`;
    }
    
    function prepararModalRelatorio(id, titulo) {
        const l = locacoes.find(x => x.id === id); if(!l) return;
        const c = locadores.find(x => x.id === l.locadorId) || { nome: 'Removido', email: '-', telefone: '-' };
        
        // VERIFICA SE √â ROMANEIO
        const isRomaneio = titulo.includes("ROMANEIO");

        // 1. GERA AS LINHAS
        let totalItens = 0;
        let totalQtd = 0;

        const linhasItens = l.items.map(item => { 
            const sub = item.valor * item.quantidade; 
            totalItens += sub; 
            totalQtd += parseInt(item.quantidade||0);

            if (isRomaneio) {
                // VISUAL DO ROMANEIO (Simples)
                return `<tr style="border-bottom:1px solid #e5e7eb;"> 
                    <td style="padding:10px; font-size:12px; color:#000000 !important;">${item.nome}</td> 
                    <td style="padding:10px; text-align:center; font-size:12px; color:#000000 !important;">${item.quantidade}</td> 
                    <td style="padding:10px; text-align:center; font-size:12px; color:#cccccc !important;">[ ___ ]</td> 
                </tr>`; 
            }
            
            // VISUAL DO CONTRATO (Completo)
            return `<tr style="border-bottom:1px solid #e5e7eb;"> 
                <td style="padding:10px; font-size:12px; color:#000000 !important;">${item.nome}</td> 
                <td style="padding:10px; text-align:center; font-size:12px; color:#000000 !important;">${item.quantidade}</td> 
                <td style="padding:10px; text-align:right; font-size:12px; color:#000000 !important;">R$ ${item.valor.toFixed(2)}</td> 
                <td style="padding:10px; text-align:right; font-size:12px; color:#000000 !important;">R$ ${sub.toFixed(2)}</td> 
                <td style="padding:10px; text-align:center; font-size:12px; color:#cccccc !important;">[ ]</td> 
            </tr>`; 
        }).join('');

        // C√ÅLCULOS
        let div = parseFloat(l.divisorFatura || 1); if(div <= 0) div = 1;
        const totalFinal = totalItens / div;
        const valorImposto = totalFinal - totalItens;
        const porcentagemImposto = (1 - div) * 100;

        // CABE√áALHOS DIFERENTES
        let cabecalhoTabela = '';
        let rodapeValores = '';
        
        // VARI√ÅVEL PARA OS TERMOS DE USO
        let termosJuridicos = '';

        if(isRomaneio) {
            cabecalhoTabela = `<tr><th style="padding:10px; text-align:left; font-size:11px; color:white !important;">ITEM</th><th style="padding:10px; text-align:center; font-size:11px; color:white !important;">QTD</th><th style="padding:10px; text-align:center; font-size:11px; color:white !important;">CONFER√äNCIA</th></tr>`;
            rodapeValores = `<h3 style="margin:0; font-size:16px; color:#000000 !important;">TOTAL DE VOLUMES: ${totalQtd}</h3>`;
        } else {
            cabecalhoTabela = `<tr><th style="padding:10px; text-align:left; font-size:11px; color:white !important;">ITEM</th><th style="padding:10px; text-align:center; font-size:11px; color:white !important;">QTD</th><th style="padding:10px; text-align:right; font-size:11px; color:white !important;">UNIT.</th><th style="padding:10px; text-align:right; font-size:11px; color:white !important;">TOTAL</th><th style="padding:10px; text-align:center; font-size:11px; color:white !important;">CHECK</th></tr>`;
            
            rodapeValores = `${div < 1 ? `<div style="margin-bottom:10px; font-size:12px; color:#444;">Itens: R$ ${totalItens.toFixed(2)} | Taxas: R$ ${valorImposto.toFixed(2)}</div>` : ''}
                             <h3 style="margin:0; font-size:22px; color:#000000 !important;">TOTAL A PAGAR: R$ ${totalFinal.toFixed(2)}</h3>`;

            // AQUI EST√Å A M√ÅGICA: OS TERMOS JUR√çDICOS (S√≥ aparecem no contrato)
            termosJuridicos = `
            <div style="margin-top: 30px; padding: 10px; border: 1px solid #000; font-size: 9px; text-align: justify; background: #f9f9f9;">
                <strong>TERMOS E CONDI√á√ïES DE LOCA√á√ÉO:</strong><br>
                1. O LOCAT√ÅRIO declara receber os materiais acima listados em perfeito estado de conserva√ß√£o e funcionamento.<br>
                2. Compromete-se a devolv√™-los na data estipulada. O atraso na devolu√ß√£o implicar√° em cobran√ßa de novas di√°rias.<br>
                3. Em caso de perda, roubo ou danos aos equipamentos, o LOCAT√ÅRIO arcar√° com o custo total de reposi√ß√£o ou reparo dos mesmos, conforme valor de mercado.<br>
                4. O transporte e manuseio dos itens s√£o de responsabilidade do LOCAT√ÅRIO, salvo acordo contr√°rio descrito neste documento.
            </div>`;
        }

        // 2. MONTAGEM FINAL
        const layout = `<div style="background:#ffffff !important; min-height:100%; width:100%; position:relative; display:flex; flex-direction:column; padding:0; color: #000000 !important;"> 
            <div style="flex: 1;"> 
                ${getHeaderMTZ()} 
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:30px; border-bottom: 2px solid #000000; padding-bottom:15px;"> 
                    <h2 style="margin:0; font-size:24px; color:#000000 !important; text-transform:uppercase;">${titulo}</h2> 
                    <div style="text-align:right; font-size:12px;"> <strong>N¬∫:</strong> #${l.id.toString().slice(-4)}<br> <strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')} </div> 
                </div> 
                <div style="display:flex; gap:40px; margin-bottom:30px;"> 
                    <div style="flex:1;"> 
                        <div style="font-size:10px; color:#666 !important; font-weight:bold; border-bottom:1px solid #eee; margin-bottom:5px;">CLIENTE</div> 
                        <div style="font-weight:bold;">${c.nome}</div> 
                        <div style="font-size:12px;">${c.telefone}</div> 
                    </div> 
                    <div style="flex:1; text-align:right;"> 
                        <div style="font-size:10px; color:#666 !important; font-weight:bold; border-bottom:1px solid #eee; margin-bottom:5px;">PER√çODO</div> 
                        <div style="font-size:13px;">De: <strong>${formatarData(l.dataAluguel).replace(/<[^>]*>/g, '')}</strong></div> 
                        <div style="font-size:13px;">At√©: <strong>${formatarData(l.dataDevolucaoPrevisao).replace(/<[^>]*>/g, '')}</strong></div> 
                    </div> 
                </div> 

                <table style="width:100%; border-collapse:collapse; margin-bottom:30px;"> 
                    <thead style="background:#000000 !important; color:white !important;">${cabecalhoTabela}</thead> 
                    <tbody>${linhasItens}</tbody> 
                </table> 
                
                <div style="text-align:right; margin-bottom:20px;">${rodapeValores}</div> 

                ${termosJuridicos}

                <div style="display:flex; justify-content:space-between; margin-top:60px;"> 
                    <div style="text-align:center; width:40%;"> <div style="border-top:1px solid #000; padding-top:10px; font-size:11px;">MTZ EVENTOS</div> </div> 
                    <div style="text-align:center; width:40%;"> <div style="border-top:1px solid #000; padding-top:10px; font-size:11px;">${c.nome.toUpperCase()}</div> </div> 
                </div> 
            </div> 
            ${getFooterMTZ()} 
        </div>`;
        
        const printArea = document.getElementById('printArea'); if(printArea) { printArea.innerHTML = layout; document.getElementById('modalRelatorio').classList.add('active'); }
    }
    function gerarRomaneio(id) { prepararModalRelatorio(id, "ROMANEIO DE SEPARA√á√ÉO"); }
    function gerarRecibo(id) { prepararModalRelatorio(id, "RECIBO DE DEVOLU√á√ÉO"); }
    function gerarRelatorio(id) { prepararModalRelatorio(id, "CONTRATO DE LOCA√á√ÉO"); }
   function gerarRelatorioAnual(clienteId) {
        const c = locadores.find(x => x.id === clienteId);
        if(!c) return;

        // 1. Coleta e calcula os dados
        const historico = locacoes.filter(l => l.locadorId === clienteId);
        let somaItens = 0;   // Valor s√≥ dos produtos
        let somaFinal = 0;   // Valor com impostos (Gross-up)

        // Ordena por data
        historico.sort((a,b) => new Date(b.dataAluguel) - new Date(a.dataAluguel));

        const linhas = historico.map(l => {
            let subtotal = 0;
            l.items.forEach(i => subtotal += (parseFloat(i.valor||0) * parseInt(i.quantidade||1)));
            
            // Aplica Gross-up
            let div = parseFloat(l.divisorFatura||1); if(div<=0) div=1;
            let final = subtotal / div;

            // Acumula totais gerais
            somaItens += subtotal;
            somaFinal += final;

            let st = l.status === 'devolvido' ? 'CONCLU√çDO' : (l.status === 'ativo' ? 'ATIVO' : 'ATRASADO');
            let cor = l.status === 'devolvido' ? '#10b981' : (l.status === 'ativo' ? '#3b82f6' : '#ef4444');

            return `<tr style="border-bottom: 1px solid #eee;">
                <td style="padding:10px; font-size:11px;">${formatarData(l.dataAluguel)}</td>
                <td style="padding:10px; font-size:11px;">#${l.id.toString().slice(-4)}</td>
                <td style="padding:10px; font-size:11px; text-align:right;">R$ ${subtotal.toFixed(2)}</td>
                <td style="padding:10px; font-size:11px; text-align:right; font-weight:bold;">R$ ${final.toFixed(2)}</td>
                <td style="padding:10px; text-align:center;"><span style="color:${cor}; font-weight:bold; font-size:10px;">${st}</span></td>
            </tr>`;
        }).join('');

        const totalImpostos = somaFinal - somaItens;

        // 2. Monta o Layout (Padronizado com os outros)
        const layout = `<div style="background:#fff !important; min-height:100%; width:100%; color:#000 !important;">
            ${getHeaderMTZ()}
            
            <div style="margin-bottom:30px; border-bottom:2px solid #000; padding-bottom:10px; display:flex; justify-content:space-between; align-items:flex-end;">
                <div><h2 style="margin:0; font-size:20px;">EXTRATO FINANCEIRO</h2><div style="font-size:14px; margin-top:5px;">${c.nome}</div></div>
                <div style="text-align:right; font-size:11px;">${new Date().toLocaleDateString('pt-BR')}</div>
            </div>

            <div style="display:flex; gap:15px; margin-bottom:30px;">
                <div style="flex:1; padding:15px; border:1px solid #ccc; text-align:center;">
                    <div style="font-size:10px; text-transform:uppercase; color:#666;">Subtotal Itens</div>
                    <div style="font-size:14px; font-weight:bold;">R$ ${somaItens.toFixed(2)}</div>
                </div>
                <div style="flex:1; padding:15px; border:1px solid #ccc; text-align:center;">
                    <div style="font-size:10px; text-transform:uppercase; color:#666;">Total Impostos</div>
                    <div style="font-size:14px; font-weight:bold;">R$ ${totalImpostos.toFixed(2)}</div>
                </div>
                <div style="flex:1; padding:15px; border:1px solid #000; background:#f9f9f9; text-align:center;">
                    <div style="font-size:10px; text-transform:uppercase; font-weight:bold;">TOTAL GERAL</div>
                    <div style="font-size:16px; font-weight:bold;">R$ ${somaFinal.toFixed(2)}</div>
                </div>
            </div>

            <table style="width:100%; border-collapse:collapse; margin-bottom:30px;">
                <thead style="background:#000; color:#fff;">
                    <tr>
                        <th style="padding:8px; text-align:left; font-size:10px; color:#fff !important;">DATA</th>
                        <th style="padding:8px; text-align:left; font-size:10px; color:#fff !important;">CONTRATO</th>
                        <th style="padding:8px; text-align:right; font-size:10px; color:#fff !important;">VALOR ITENS</th>
                        <th style="padding:8px; text-align:right; font-size:10px; color:#fff !important;">TOTAL (C/ IMP)</th>
                        <th style="padding:8px; text-align:center; font-size:10px; color:#fff !important;">STATUS</th>
                    </tr>
                </thead>
                <tbody>${linhas}</tbody>
            </table>
            
            ${getFooterMTZ()}
        </div>`;
        
        const printArea = document.getElementById('printArea'); 
        if(printArea) { 
            printArea.innerHTML = layout; 
            document.getElementById('modalRelatorio').classList.add('active'); 
        }
    }
    function gerarPDF() { 
        if (!window.jspdf || !window.html2canvas) { alert("Aguarde o carregamento das bibliotecas..."); return; } 
        const { jsPDF } = window.jspdf; 
        const elemento = document.getElementById("printArea"); 
        
        html2canvas(elemento, { scale: 2, useCORS: true, logging: false }).then(canvas => { 
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4'); 
            const pdfWidth = pdf.internal.pageSize.getWidth(); 
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight); 
            pdf.save(`MTZ_Doc_${Date.now()}.pdf`); 
        });
    }

    // --- OUTROS ---
    function carregarItensDevolucao() { 
        const id = document.getElementById('devLocacao').value; const div = document.getElementById('divItensDevolucao'); 
        div.innerHTML = ""; if(!id) return; const l = locacoes.find(x => x.id == id); if(!l) return;
        div.innerHTML = l.items.map((item) => `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid var(--border);"><span>${item.nome} (${item.quantidade})</span> <span class="badge badge-success">OK</span></div>`).join('');
    }
    function confirmarDevolucao() { 
    const id = document.getElementById('devLocacao').value;
    if(!id) return alert("Selecione!");
    
    const l = locacoes.find(x => x.id == id);
    l.status = 'devolvido';
    
    devolucoes.push({ 
        id: Date.now(), 
        locacaoId: l.id, 
        dataDevolucao: document.getElementById('devData').value, 
        obs: 'Total' 
    });
    
    salvarLocal();
    renderTudo();
    sincronizar('salvar');
    
    // Registra no log de auditoria
    const cliente = locadores.find(x => x.id === l.locadorId);
    registrarLog('devolucao', 'criar', `Devolu√ß√£o registrada: ${cliente?.nome || 'Cliente'}`);
    
    mostrarToast("Baixa confirmada!");
}

    function converterLogo() { const input = document.getElementById('confLogo'); if (input.files[0]) { const reader = new FileReader();
    reader.onloadend = function() { config.logo = reader.result; document.getElementById('previewLogo').innerHTML = `<img src="${config.logo}" style="height:50px">`; }; reader.readAsDataURL(input.files[0]); } }
    
    // --- FUN√á√ïES DE BACKUP ---
    function baixarBackup() {
        const dados = JSON.stringify({locadores, pecas, locacoes, devolucoes, tipos, config});
        const blob = new Blob([dados], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `MTZ_Backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        mostrarToast("Backup baixado!");
    }

    function restaurarBackup(input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const j = JSON.parse(e.target.result);
                if (confirm("Isso substituir√° todos os dados atuais. Continuar?")) {
                    locadores = j.locadores || [];
                    pecas = j.pecas || [];
                    locacoes = j.locacoes || [];
                    devolucoes = j.devolucoes || [];
                    tipos = j.tipos || [];
                    config = j.config || config;
                    salvarLocal();
                    renderTudo();
                    sincronizar('salvar');
                    mostrarToast("Backup restaurado com sucesso!");
                }
            } catch (erro) {
                alert("Erro ao ler arquivo de backup: " + erro);
            }
        };
        reader.readAsText(input.files[0]);
    }

    // --- FUN√á√ïES DO SCANNER ---
    let scannerAtivo = false;
    function iniciarScanner(modo) {
        const modal = document.getElementById('modalScanner');
        modal.classList.add('active');
        
        if (scannerAtivo) Quagga.stop();

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: { facingMode: "environment" }
            },
            decoder: { readers: ["code_128_reader", "ean_reader"] }
        }, function(err) {
            if (err) { console.log(err); return; }
            Quagga.start();
            scannerAtivo = true;
        });

        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            if (modo === 'cadastro') {
                document.getElementById('pecaBar').value = code;
                mostrarToast("C√≥digo lido: " + code);
            } else if (modo === 'locacao') {
                const peca = pecas.find(p => p.codigo === code || (p.barras && p.barras === code)); 
                if (peca) {
                    document.getElementById('aluguelItemSelect').value = peca.id;
                    mostrarToast("Item encontrado: " + peca.nome);
                } else {
                    mostrarToast("Item n√£o encontrado!", "erro");
                }
            }
            fecharScanner();
        });
    }

    function fecharScanner() {
        document.getElementById('modalScanner').classList.remove('active');
        if (scannerAtivo) {
            Quagga.stop();
            scannerAtivo = false;
        }
    }

    // --- FUN√á√ÉO DE LIMPEZA E ARQUIVAMENTO (VERS√ÉO MATA-FANTASMAS) ---
    function arquivarHistorico() {
        // PASSO 1: FAXINA IMEDIATA (Remove os tra√ßos "-" da tela)
        const historicoAntes = devolucoes.length;
        devolucoes = devolucoes.filter(d => locacoes.some(l => l.id === d.locacaoId));
        
        const historicoDepois = devolucoes.length;
        const fantasmasRemovidos = historicoAntes - historicoDepois;

        // Se encontrou "fantasmas", limpa eles e avisa
        if (fantasmasRemovidos > 0) {
            salvarLocal();
            renderTudo();
            sincronizar('salvar');
            return mostrarToast(`Faxina completa! ${fantasmasRemovidos} registros vazios removidos.`);
        }

        // PASSO 2: ARQUIVAMENTO NORMAL
        const contratosParaArquivar = locacoes.filter(l => l.status === 'devolvido');
        const contratosParaManter = locacoes.filter(l => l.status !== 'devolvido');

        if (contratosParaArquivar.length === 0) return mostrarToast("Nada novo para arquivar!", "erro");

        if (!confirm(`Confirma arquivar ${contratosParaArquivar.length} contratos finalizados?\n(Eles sair√£o do sistema e ser√£o salvos num arquivo)`)) return;

        const dadosMortos = JSON.stringify({ 
            data: new Date(), 
            contratos: contratosParaArquivar
        });
        
        const blob = new Blob([dadosMortos], {type: "application/json"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `MTZ_Arquivo_Morto_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        locacoes = contratosParaManter;
        devolucoes = devolucoes.filter(d => locacoes.some(l => l.id === d.locacaoId));

        salvarLocal();
        renderTudo();
        sincronizar('salvar');
        mostrarToast("Sistema limpo e otimizado!");
    }
        // --- FUN√á√ÉO WHATSAPP (TEXTO LIMPO - SEM NEGRITO) ---
    function enviarZap(id) {
        const l = locacoes.find(x => x.id === id);
        if(!l) return;
        const c = locadores.find(x => x.id === l.locadorId);
        
        if (!c || !c.telefone) {
            return mostrarToast("Cliente sem telefone cadastrado!", "erro");
        }

        let fone = c.telefone.replace(/\D/g, '');
        if(fone.length <= 11) fone = "55" + fone;

        let textoItens = "";
        l.items.forEach(item => {
            textoItens += `>> ${item.quantidade}x ${item.nome}\n`;
        });

        let total = 0;
        l.items.forEach(i => total += (parseFloat(i.valor||0)*parseInt(i.quantidade||1)));
        let div = parseFloat(l.divisorFatura||1); if(div<=0) div=1;
        let valorFinal = total/div;

        // MENSAGEM LIMPA (Tirei todos os asteriscos *)
        const msg = `Ol√° ${c.nome}! Tudo bem?
Aqui est√° o seu pedido na MTZ Eventos:

DATA: ${formatarData(l.dataAluguel).replace(/<[^>]*>/g, '')}

ITENS SELECIONADOS:
${textoItens}
TOTAL FINAL: R$ ${valorFinal.toFixed(2)}

Fico no aguardo!`;

        window.open(`https://wa.me/${fone}?text=${encodeURIComponent(msg)}`, '_blank');
    }
        // --- FUN√á√ïES DE TRAVA DE ESTOQUE ---
    function atualizarLimiteEstoque() {
        var select = document.getElementById('aluguelItemSelect');
        var inputQtd = document.getElementById('aluguelQtd');
        var aviso = document.getElementById('avisoEstoque');
        
        var id = select.value;
        var p = pecas.find(x => x.id == id);

        if (p) {
            inputQtd.max = p.disponivel; // Define o m√°ximo
            inputQtd.value = 1; 
            aviso.innerText = `(M√°x: ${p.disponivel})`; // Mostra o aviso vermelho
        } else {
            aviso.innerText = "";
            inputQtd.removeAttribute("max");
        }
    }

    function validarDigitacao(input) {
        var maximo = parseInt(input.max);
        var valorDigitado = parseInt(input.value);

        if (!isNaN(maximo) && valorDigitado > maximo) {
            input.value = maximo; // Se passar, volta pro m√°ximo
            mostrarToast("Limite de estoque atingido!", "erro");
        }
        if (valorDigitado < 1) input.value = 1;
    }
      // 1. Registra o Service Worker (Obrigat√≥rio para instalar)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('Service Worker Registrado!'))
                .catch((err) => console.error('Erro no SW:', err));
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            const btn = document.createElement('div');
            btn.innerHTML = '<i class="bi bi-phone"></i> INSTALAR APP';
            btn.style.cssText = `
                position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
                background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white;
                padding: 12px 30px; border-radius: 50px; font-weight: bold;
                box-shadow: 0 10px 25px rgba(37, 99, 235, 0.5); cursor: pointer; z-index: 9999;
                display: flex; align-items: center; gap: 10px; font-family: sans-serif;
            `;
            
            document.body.appendChild(btn);

            btn.onclick = () => {
                // CHAMA A INSTALA√á√ÉO NA HORA (Sem atrasos!)
                deferredPrompt.prompt();
                
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        btn.style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            };
        });
// === MONITOR DE ARMAZENAMENTO ===
function verificarEspacoStorage() {
    try {
        const backup = localStorage.getItem('mtzBackup');
        if (!backup) return;
        
        const tamanhoKB = (new Blob([backup]).size / 1024).toFixed(2);
        const percentual = Math.round((tamanhoKB / 5120) * 100);
        
        console.log(`üìä Storage: ${tamanhoKB} KB (${percentual}% de 5 MB)`);
        
        if (percentual >= 90) {
            mostrarToast('üî¥ CR√çTICO: Storage em ' + percentual + '%! FA√áA BACKUP AGORA!', 'erro');
        } else if (percentual >= 75) {
            mostrarToast('‚ö†Ô∏è ALERTA: Storage em ' + percentual + '%!', 'erro');
        }
    } catch (erro) {
        console.error('Erro ao verificar storage:', erro);
    }
}

// Executar verifica√ß√£o ao carregar
window.addEventListener('load', function() {
    setTimeout(verificarEspacoStorage, 2000);
});

   let estoqueSelecionados = new Set();

function onSelectEstoque(id, checked){
  id = Number(id);
  if (checked) estoqueSelecionados.add(id);
  else estoqueSelecionados.delete(id);
}

function toggleSelecionarTodosEstoque(marcar) {
  const checks = document.querySelectorAll('.chk-estoque');
  checks.forEach(chk => {
    chk.checked = marcar;
    onSelectEstoque(chk.dataset.id, marcar);
  });
}

function excluirSelecionadosEstoque(){
  if (estoqueSelecionados.size === 0) return mostrarToast('Selecione pelo menos 1 item.', 'erro');
  if (!confirm(`Excluir ${estoqueSelecionados.size} item(ns) do estoque?`)) return;

  const ids = new Set([...estoqueSelecionados].map(Number));
  const removidos = pecas.filter(p => ids.has(p.id));
  pecas = pecas.filter(p => !ids.has(p.id));

  removidos.forEach(p => registrarLog('item', 'deletar', `Item removido (lote): ${p.nome} ID ${p.id}`));

  estoqueSelecionados.clear();
  salvarLocal();
  renderEstoque();
  sincronizar('salvar');
  mostrarToast('Itens exclu√≠dos!');
}
     
    </script>
</body>
</html>

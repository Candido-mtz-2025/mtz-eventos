<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./logo.png">
    <link rel="apple-touch-icon" href="./logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema MTZ Eventos - V11 Final</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <script src="https://accounts.google.com/gsi/client" async defer></script><!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./logo.png">
    <link rel="apple-touch-icon" href="./logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema MTZ Eventos - V11 Final</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <script src="https://accounts.google.com/gsi/client" async defer></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    /* === ESTILO V9: CLEAN & MODERN === */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    :root {
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --bg: #e2e8f0; 
        --surface: #ffffff;
        --surface-hover: #f8fafc;
        --text: #0f172a;
        --text-light: #64748b;
        --border: #cbd5e1;
        --input-bg: #f1f5f9;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --radius: 12px;
    }

    [data-theme="dark"] {
        --primary: #60a5fa;
        --primary-hover: #3b82f6;
        --bg: #0f172a; 
        --surface: #1e293b; 
        --surface-hover: #334155;
        --text: #f8fafc;
        --text-light: #94a3b8;
        --border: #334155;
        --input-bg: #0f172a;
        --shadow: none;
    }

    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; -webkit-font-smoothing: antialiased; }
    * { box-sizing: border-box; }

    /* CONTAINERS & CARDS */
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .card, .dash-section, .modal-content, .login-box {
        background: var(--surface) !important;
        border: none; 
        box-shadow: var(--shadow);
        border-radius: var(--radius);
        color: var(--text);
        padding: 25px;
        margin-bottom: 24px;
    }

    /* LOGIN */
    #loginArea { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .login-box { width: 100%; max-width: 400px; text-align: center; }

    /* HEADER */
    header .container { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }
    .logo h1 { font-size: 1.6rem; color: var(--text) !important; margin: 0; }

    /* INPUTS MODERNOS */
    .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
    .form-group { flex: 1; display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 0.85rem; font-weight: 600; color: var(--text-light); margin-left: 2px; }
    input, select {
        background: var(--input-bg);
        color: var(--text);
        border: 1px solid transparent; padding: 12px 15px;
        border-radius: 10px; width: 100%; outline: none; transition: 0.2s; font-size: 0.95rem;
    }
    input:focus, select:focus { background: var(--surface); border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); }

    /* TABELAS */
    .table-responsive { border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
    .table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .table th { background: var(--surface-hover); color: var(--text-light); padding: 14px 20px; text-transform: uppercase; font-size: 0.75rem; font-weight: 700; border-bottom: 1px solid var(--border); text-align: left; }
    .table td { padding: 16px 20px; vertical-align: middle; color: var(--text); border-bottom: 1px solid var(--border); }
    .table tbody tr:hover { background-color: var(--surface-hover); }
    .col-actions { text-align: right !important; width: 1%; white-space: nowrap; }
    .actions-cell { display: flex; justify-content: flex-end; gap: 8px; }

    /* BOT√ïES & BADGES */
    .btn { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: 0.2s; }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-info { background: #0ea5e9; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; }
    
    .badge { padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-warning { background: #fef9c3; color: #854d0e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #e0f2fe; color: #075985; }

    /* DASHBOARD */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .stat-card { display: flex; align-items: center; justify-content: space-between; padding: 25px; position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-3px); }
    .stat-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
    .card-blue::before { background: #3b82f6; } .card-blue .stat-icon { background: #eff6ff; color: #3b82f6; }
    .card-orange::before { background: #f59e0b; } .card-orange .stat-icon { background: #fffbeb; color: #f59e0b; }
    .card-green::before { background: #10b981; } .card-green .stat-icon { background: #ecfdf5; color: #10b981; }
    .card-purple::before { background: #8b5cf6; } .card-purple .stat-icon { background: #f5f3ff; color: #8b5cf6; }
    .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }

    /* TABS */
    .tabs-container { width: 100%; display: flex; justify-content: flex-start; }
    .tabs { width: 100%; display: flex; justify-content: flex-start; align-items: center; gap: 5px; overflow-x: auto; padding: 5px; background: var(--surface); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 25px; box-sizing: border-box; }
    .tab-btn { flex: 0 0 auto; background: transparent; border: none; padding: 10px 20px; color: var(--text-light); font-weight: 600; cursor: pointer; border-radius: 8px; white-space: nowrap; }
    .tab-btn.active { background: var(--primary); color: white; }
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* OUTROS */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 5000; align-items: center; justify-content: center; padding: 20px; }
    .modal.active { display: flex; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
    .modal-header h3 { margin: 0; font-size: 1.2rem; }
    .btn-close-modal { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 1rem; }
    
    .sync-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px; text-transform: uppercase; }
    .sync-online { background: #dcfce7; color: #166534; }
    .sync-offline { background: #f1f5f9; color: #475569; }
    .sync-saving { background: #fff7ed; color: #9a3412; }
    
    #toast { visibility: hidden; min-width: 250px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 6000; left: 50%; bottom: 30px; transform: translateX(-50%); opacity: 0; transition: 0.3s; }
    #toast.show { visibility: visible; bottom: 40px; opacity: 1; }

    /* CARRINHO */
    .box-carrinho { background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    [data-theme="dark"] .box-carrinho { background: rgba(0, 0, 0, 0.2); border: 1px solid #334155; }
    .item-carrinho { display: flex; justify-content: space-between; background: var(--surface-hover); padding: 8px 12px; border-radius: 6px; border-left: 3px solid var(--primary); margin-bottom: 5px; }

    /* AUTOCOMPLETE */
    .dropdown-sugestoes { display: none; position: absolute; background: var(--surface); width: 100%; max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 0 0 10px 10px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .dropdown-sugestoes.ativo { display: block; }
    .sugestao-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
    .sugestao-item:hover { background: var(--surface-hover); }

    /* MOBILE */
    @media (max-width: 768px) {
        .container { padding: 15px; padding-bottom: 80px; }
        header .container { flex-direction: column; gap: 15px; align-items: stretch; text-align: center; }
        .form-row { flex-direction: column; gap: 15px; }
        .dashboard-grid { grid-template-columns: 1fr; }
        .modal-content { width: 100%; max-width: 100%; border-radius: 20px 20px 0 0; margin: 0; max-height: 90vh; overflow-y: auto; }
    }
</style>
</head>
<body>

    <div id="loginArea">
        <div class="login-box">
            <h1 style="color:var(--primary); margin-bottom:5px;">MTZ Eventos</h1>
            <p style="margin-bottom: 30px; color:var(--text-light);">Sistema de Gest√£o & Loca√ß√£o V11</p>
            
            <button id="btnLoginGoogle" class="btn" style="width: 100%; margin-bottom: 15px; background-color: #1e293b; color: white; justify-content: center; padding: 14px;" onclick="fazerLoginGoogle()">
                <i class="bi bi-google"></i> Entrar com Google
            </button>
            <button class="btn" style="width: 100%; background-color: var(--primary); color: white; justify-content: center; padding: 14px;" onclick="entrarOffline()">
                <i class="bi bi-hdd"></i> Usar Offline (Local)
            </button>
        </div>
    </div>

    <div id="appArea" style="display: none;">
        <header>
            <div class="container">
                <div class="logo">
                    <h1>MTZ Eventos</h1>
                    <p style="font-size:0.85rem; color:var(--text-light);">Painel de Controle</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div id="syncBadge" class="sync-badge sync-offline"><i class="bi bi-circle-fill"></i> <span id="syncText">Offline</span></div>
                    <button class="btn btn-secondary btn-sm" onclick="toggleTheme()"><i class="bi bi-moon"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="sair()"><i class="bi bi-box-arrow-right"></i></button>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab-btn active" onclick="abrirTab('dashboard')"><i class="bi bi-grid"></i> Dashboard</button>
                    <button class="tab-btn" onclick="abrirTab('locadores')"><i class="bi bi-people"></i> Clientes</button>
                    <button class="tab-btn" onclick="abrirTab('tipos')"><i class="bi bi-tags"></i> Tipos</button>
                    <button class="tab-btn" onclick="abrirTab('estoque')"><i class="bi bi-box-seam"></i> Estoque</button>
                    <button class="tab-btn" onclick="abrirTab('locacoes')"><i class="bi bi-cart"></i> Loca√ß√µes</button>
                    <button class="tab-btn" onclick="abrirTab('devolucoes')"><i class="bi bi-arrow-return-left"></i> Devolu√ß√µes</button>
                    <button class="tab-btn" onclick="abrirTab('auditoria')"><i class="bi bi-shield-check"></i> Auditoria</button>
                    <button class="tab-btn" onclick="abrirTab('config')"><i class="bi bi-gear"></i> Config</button>
                </div>
            </div>

            <div id="tab-dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card card-blue" onclick="abrirTab('locadores')">
                        <div class="stat-info"><h3 id="dashClientes">0</h3><p>Clientes</p></div>
                        <div class="stat-icon"><i class="bi bi-people"></i></div>
                    </div>
                    <div class="stat-card card-orange" onclick="irParaLocacoes('todos')">
                        <div class="stat-info"><h3 id="dashLocacoes">0</h3><p>Loca√ß√µes Ativas</p></div>
                        <div class="stat-icon"><i class="bi bi-cart"></i></div>
                    </div>
                    <div class="stat-card card-green">
                        <div class="stat-info"><h3 id="dashFaturamento" style="font-size:1.4rem;">R$ 0,00</h3><p>Receita</p></div>
                        <div class="stat-icon"><i class="bi bi-currency-dollar"></i></div>
                    </div>
                    <div class="stat-card card-purple" onclick="irParaLocacoes('atrasado')">
                        <div class="stat-info"><h3 id="dashAtrasos">0</h3><p>Atrasos</p></div>
                        <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    </div>
                </div>
                <div class="dash-section">
                    <h3><i class="bi bi-calendar-event"></i> Pr√≥ximas Devolu√ß√µes</h3>
                    <div class="table-responsive">
                        <table class="table"><thead><tr><th>Data</th><th>Cliente</th><th style="text-align:center">Status</th></tr></thead><tbody id="tblDashDevolucoes"></tbody></table>
                    </div>
                </div>
            </div>

            <div id="tab-locadores" class="tab-content">
                <div class="card">
                    <h3>Novo Cliente</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Nome Completo</label><input type="text" id="locNome"></div>
                        <div class="form-group"><label>CPF / CNPJ</label><input type="text" id="locDoc"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Email</label><input type="email" id="locEmail"></div>
                        <div class="form-group"><label>Telefone</label><input type="tel" id="locTel"></div>
                    </div>
                    <button class="btn btn-primary" onclick="salvarLocador()">Cadastrar</button>
                </div>
                <div class="card">
                    <input type="text" id="buscaCliente" placeholder="üîç Buscar cliente..." onkeyup="buscarComDebounce('locadores')" style="margin-bottom: 15px;">
                    <div class="table-responsive"><table class="table"><tbody id="tblLocadores"></tbody></table></div>
                </div>
            </div>

            <div id="tab-tipos" class="tab-content">
                <div class="card">
                    <h3>Novo Tipo</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Nome</label><input type="text" id="tipoNome"></div>
                        <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="tipoDesc"></div>
                    </div>
                    <button class="btn btn-primary" onclick="salvarTipo()">Salvar</button>
                </div>
                <div class="card"><div class="table-responsive"><table class="table"><tbody id="tblTipos"></tbody></table></div></div>
            </div>

            <div id="tab-estoque" class="tab-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h2 style="margin:0;">Stock</h2>
                    <button class="btn btn-success" onclick="document.getElementById('inputExcel').click()">Importar Excel</button>
                </div>
                <input type="file" id="inputExcel" accept=".xlsx, .xls" style="display:none" onchange="processarExcelInteligente(this)">
                
                <div class="card">
                    <h3>Novo Item</h3>
                    <div class="form-row">
                        <div class="form-group"><label>C√≥digo</label><input type="text" id="pecaCod"></div>
                        <div class="form-group"><label>Categoria</label><select id="pecaTipo"></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Nome</label><input type="text" id="pecaNome"></div>
                        <div class="form-group"><label>Medida</label><input type="text" id="pecaMedida"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Valor (R$)</label><input type="number" id="pecaValor" step="0.01"></div>
                        <div class="form-group"><label>Qtd</label><input type="number" id="pecaQtd" value="1"></div>
                        <div class="form-group"><label>C√≥d Barras</label><div style="display:flex; gap:5px;"><input type="text" id="pecaBar"><button class="btn btn-secondary" onclick="iniciarScanner('cadastro')"><i class="bi bi-qr-code"></i></button></div></div>
                    </div>
                    <button class="btn btn-primary" onclick="salvarPeca()">Salvar Item</button>
                </div>

                <div class="card">
                    <input type="text" id="buscaEstoque" placeholder="üîç Buscar..." onkeyup="buscarComDebounce('estoque')" style="margin-bottom:12px;">
                    <div style="margin-bottom:12px;"><button class="btn btn-danger btn-sm" onclick="excluirSelecionadosEstoque()">Excluir selecionados</button></div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th style="width:40px;"><input type="checkbox" id="chkAllEstoque" onchange="toggleSelecionarTodosEstoque(this.checked)"></th><th>Img</th><th>C√≥d</th><th>Tipo</th><th>Nome</th><th>Valor</th><th>Estoque</th><th class="col-actions">A√ß√µes</th></tr></thead>
                            <tbody id="tblEstoque"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-locacoes" class="tab-content">
                <div class="card">
                    <h3>Nova Loca√ß√£o</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Cliente</label><select id="aluguelCliente"></select></div>
                        <div class="form-group"><label>Divisor</label><input type="number" id="aluguelDivisor" value="0.8367"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>In√≠cio</label><input type="date" id="aluguelIni"></div>
                        <div class="form-group"><label>Fim</label><input type="date" id="aluguelFim"></div>
                    </div>

                    <div class="box-carrinho">
                        <h4><i class="bi bi-cart-plus"></i> Itens</h4>
                        <div class="form-row" style="align-items:flex-end;">
                            <div class="form-group" style="flex:4; position:relative;">
                                <label>Buscar Item</label>
                                <input type="text" id="inputBuscaPeca" onkeyup="filtrarItensLocacao()" autocomplete="off">
                                <input type="hidden" id="aluguelItemSelect">
                                <div id="listaSugestoes" class="dropdown-sugestoes"></div>
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label>Qtd</label>
                                <input type="number" id="aluguelQtd" value="1" style="text-align:center;" oninput="validarDigitacao(this)">
                            </div>
                            <div class="form-group" style="flex:2; flex-direction:row;">
                                <button class="btn btn-success" style="flex:1;" onclick="addItemCarrinho()">Add</button>
                                <button class="btn btn-secondary" style="width:50px;" onclick="iniciarScanner('locacao')"><i class="bi bi-qr-code"></i></button>
                            </div>
                        </div>
                        <div id="carrinhoList"><i>Nenhum item adicionado.</i></div>
                    </div>
                    <button class="btn btn-primary" onclick="finalizarLocacao()">Concluir</button>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:15px; overflow-x:auto;">
                    <button class="btn btn-sm btn-secondary" onclick="mudarFiltro('todos')">Todos</button>
                    <button class="btn btn-sm btn-success" onclick="mudarFiltro('ativo')">Em Aberto</button>
                    <button class="btn btn-sm btn-danger" onclick="mudarFiltro('atrasado')">Atrasados</button>
                    <button class="btn btn-sm btn-info" onclick="mudarFiltro('devolvido')">Hist√≥rico</button>
                </div>
                <div class="card">
                    <div class="table-responsive"><table class="table"><tbody id="tblLocacoes"></tbody></table></div>
                </div>
            </div>

            <div id="tab-devolucoes" class="tab-content">
                <div class="card">
                    <h3>Registrar Devolu√ß√£o</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Loca√ß√£o</label><select id="devLocacao" onchange="carregarItensDevolucao()"></select></div>
                        <div class="form-group"><label>Data</label><input type="date" id="devData"></div>
                    </div>
                    <div id="divItensDevolucao" style="margin:15px 0; padding:15px; border:1px solid var(--border); border-radius:8px;"></div>
                    <button class="btn btn-primary" onclick="confirmarDevolucao()">Confirmar Baixa</button>
                </div>
                <div class="card">
                    <h3>Hist√≥rico</h3>
                    <div class="table-responsive"><table class="table"><tbody id="tblDevolucoes"></tbody></table></div>
                </div>
            </div>

            <div id="tab-auditoria" class="tab-content">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h3>Auditoria</h3>
                        <div>
                            <button class="btn btn-info btn-sm" onclick="exportarLogsCSV()">Exportar</button>
                            <button class="btn btn-danger btn-sm" onclick="if(confirm('Limpar?')) limparLogsAntigos()">Limpar</button>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:15px; overflow-x:auto;">
                        <button class="btn btn-sm btn-secondary" onclick="renderLogs('todos')">Todos</button>
                        <button class="btn btn-sm btn-success" onclick="renderLogs('cliente')">Clientes</button>
                        <button class="btn btn-sm btn-success" onclick="renderLogs('item')">Itens</button>
                        <button class="btn btn-sm btn-warning" onclick="renderLogs('locacao')">Loca√ß√µes</button>
                    </div>
                    <div class="table-responsive"><table class="table"><tbody id="tblLogs"></tbody></table></div>
                </div>
            </div>

            <div id="tab-config" class="tab-content">
                <div class="card">
                    <h3>Personaliza√ß√£o</h3>
                    <div class="form-row"><div class="form-group"><label>Rodap√© PDF</label><input type="text" id="confRodape"></div></div>
                    <div class="form-row">
                        <div class="form-group"><label>Telefone</label><input type="text" id="confTel"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="confEmail"></div>
                    </div>
                    <div class="form-group"><label>Logo</label><input type="file" id="confLogo" onchange="converterLogo()"></div>
                    <div id="previewLogo" style="margin:10px 0;"></div>
                    <button class="btn btn-primary" onclick="salvarConfig()">Salvar</button>
                </div>
                <div class="card">
                    <h3>Backup</h3>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-info" onclick="baixarBackup()">Baixar JSON</button>
                        <button class="btn btn-warning" onclick="document.getElementById('fileRestore').click()">Restaurar JSON</button>
                        <button class="btn btn-danger" onclick="arquivarHistorico()">Limpeza</button>
                        <input type="file" id="fileRestore" style="display:none;" onchange="restaurarBackup(this)">
                    </div>
                </div>
            </div>
        </div> </div> <div id="modalEditarLocador" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar Cliente</h3><button class="btn-close-modal" onclick="fecharModal('modalEditarLocador')">X</button></div>
            <input type="hidden" id="editLocId">
            <div class="form-group"><label>Nome</label><input type="text" id="editLocNome"></div>
            <div class="form-group"><label>Email</label><input type="email" id="editLocEmail"></div>
            <div class="form-group"><label>Telefone</label><input type="tel" id="editLocTel"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="salvarEdicaoLocador()">Salvar</button>
        </div>
    </div>

    <div id="modalEditarPeca" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar Item</h3><button class="btn-close-modal" onclick="fecharModal('modalEditarPeca')">X</button></div>
            <input type="hidden" id="editPecaId">
            <div class="form-row">
                <div class="form-group"><label>C√≥digo</label><input type="text" id="editPecaCod"></div>
                <div class="form-group"><label>Tipo</label><select id="editPecaTipo"></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Nome</label><input type="text" id="editPecaNome"></div>
                <div class="form-group"><label>Valor</label><input type="number" id="editPecaValor" step="0.01"></div>
            </div>
            <div class="form-group"><label>Qtd</label><input type="number" id="editPecaQtd"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="salvarEdicaoPeca()">Salvar</button>
        </div>
    </div>

    <div id="modalEditarTipo" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar Tipo</h3><button class="btn-close-modal" onclick="fecharModal('modalEditarTipo')">X</button></div>
            <input type="hidden" id="editTipoId">
            <div class="form-group"><label>Nome</label><input type="text" id="editTipoNome"></div>
            <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="editTipoDesc"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="salvarEdicaoTipo()">Salvar</button>
        </div>
    </div>

    <div id="modalScanner" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Leitor QR</h3><button class="btn-close-modal" onclick="fecharScanner()">X</button></div>
            <div id="interactive" class="viewport" style="width:100%; height:250px; background:#000;"></div>
        </div>
    </div>
    
    <div id="modalRelatorio" class="modal">
        <div class="modal-content" style="max-width:900px; padding:0; height:90vh; display:flex; flex-direction:column;">
            <div style="padding:15px; background:#333; color:white; display:flex; justify-content:space-between;">
                <span>Impress√£o</span>
                <div>
                    <button class="btn btn-primary btn-sm" onclick="gerarPDF()">PDF</button>
                    <button class="btn btn-danger btn-sm" onclick="fecharModal('modalRelatorio')">Fechar</button>
                </div>
            </div>
            <div style="flex:1; overflow-y:auto; padding:20px; background:#555; display:flex; justify-content:center;">
                <div id="printArea" class="invoice-box"></div>
            </div>
        </div>
    </div>

    <div id="toast"></div>

<script>
const DOM={_cache:{},get(e){return this._cache[e]||(this._cache[e]=document.getElementById(e)),this._cache[e]}};
let locadores=[],pecas=[],locacoes=[],devolucoes=[],tipos=[],carrinhoLocacao=[],logsAuditoria=[];
let config={rodape:"MTZ Eventos",tel:"",email:"",logo:""},tokenClient,filtroAtual='todos';
let paginaAtual={locadores:1,pecas:1,locacoes:1};
const ITENS_POR_PAGINA=50;

function filtrarItensLocacao(){
    const t=document.getElementById('inputBuscaPeca'),l=document.getElementById('listaSugestoes');
    if(!t||!l)return;
    const term=t.value.toLowerCase();l.innerHTML='';
    if(term.length<2){l.classList.remove('ativo');return;}
    const fils=pecas.filter(p=>(p.nome&&p.nome.toLowerCase().includes(term))||(p.codigo&&p.codigo.toLowerCase().includes(term)));
    if(!fils.length){l.classList.remove('ativo');return;}
    fils.forEach(p=>{
        const i=document.createElement('div');i.className='sugestao-item';
        i.innerHTML=`<span>${p.nome}</span><span style="font-size:0.8rem;color:${p.disponivel>0?'var(--primary)':'red'}">(Disp: ${p.disponivel})</span>`;
        i.onclick=()=>{
            t.value=p.nome;document.getElementById('aluguelItemSelect').value=p.id;
            document.getElementById('aluguelQtd').focus();atualizarLimiteEstoque();l.classList.remove('ativo');
        };
        l.appendChild(i);
    });
    l.classList.add('ativo');
}
document.addEventListener('click',e=>{if(!e.target.closest('.form-group')){const l=document.getElementById('listaSugestoes');if(l)l.classList.remove('ativo');}});

function renderTudo(){
    if(typeof renderLocacoes==='function')renderLocacoes();
    if(typeof renderLocadores==='function')renderLocadores();
    if(typeof renderEstoque==='function')renderEstoque();
    if(typeof renderDevolucoes==='function')renderDevolucoes();
    if(typeof renderTipos==='function')renderTipos();
    if(typeof renderStats==='function')renderStats();
    if(typeof updateSelects==='function')updateSelects();
    if(typeof renderLogs==='function')renderLogs();
    if(typeof renderConfig==='function')renderConfig();
}
let cacheDisponibilidade=null,ultimaAtualizacaoCache=0;
function debounce(f,d){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>f.apply(this,a),d);}}
const buscarComDebounce=debounce(function(t){if(t==='locadores')renderLocadores();if(t==='estoque')renderEstoque();},300);

function registrarLog(t,a,d,data=null){
    const l={id:Date.now(),timestamp:new Date().toISOString(),data:new Date().toLocaleString('pt-BR'),tipo:t,acao:a,descricao:d,usuario:localStorage.getItem('usuarioEmail')||'Offline',dados:data};
    logsAuditoria.unshift(l);if(logsAuditoria.length>1000)logsAuditoria=logsAuditoria.slice(0,1000);
}
function limparLogsAntigos(){
    const limit=Date.now()-(90*24*60*60*1000);logsAuditoria=logsAuditoria.filter(l=>l.id>limit);salvarLocal();renderLogs();
}
function exportarLogsCSV(){
    if(!logsAuditoria.length)return mostrarToast('Sem logs','erro');
    let csv='Data,Hora,Tipo,Acao,Descricao\n';
    logsAuditoria.forEach(l=>{
        const d=new Date(l.timestamp);
        csv+=`"${d.toLocaleDateString()}","${d.toLocaleTimeString()}","${l.tipo}","${l.acao}","${l.descricao}"\n`;
    });
    const b=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='logs.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);
}
function renderLogs(f='todos'){
    const tb=document.getElementById('tblLogs');if(!tb)return;
    let l=logsAuditoria;if(f!=='todos')l=l.filter(x=>x.tipo===f);
    tb.innerHTML=l.slice(0,100).map(x=>`<tr><td>${new Date(x.timestamp).toLocaleString()}</td><td>${x.tipo}</td><td>${x.acao}</td><td>${x.descricao}</td><td>${x.usuario}</td></tr>`).join('');
}

const GOOGLE_CLIENT_ID='981345912804-uim8kctqnts15kt6l8odhif3hil6udek.apps.googleusercontent.com';
const API_URL='https://script.google.com/macros/s/AKfycbxZoCyJZrG2WZfIuPA3Iyz6d-PIdnzFi-Ejnl3gAUB-l9mGnBJt0BpyBErzMI_GFuZuhA/exec';

function formatarData(s){if(!s)return '---';const d=new Date(s);return isNaN(d)?'Aberta':new Date(d.getTime()+d.getTimezoneOffset()*60000).toLocaleDateString('pt-BR');}

window.onload=function(){
    carregarLocal();
    const h=new Date().toISOString().split('T')[0];
    const i=document.getElementById('aluguelIni'),d=document.getElementById('devData');
    if(i)i.value=h;if(d)d.value=h;
    if(localStorage.getItem('theme')==='dark')document.body.setAttribute('data-theme','dark');
    if(window.google)gisLoaded();
    if(localStorage.getItem('gToken'))entrarApp();
    setInterval(salvarLocal,60000);
};

function toggleTheme(){
    const b=document.body,d=b.getAttribute('data-theme')==='dark';
    b.setAttribute('data-theme',d?'light':'dark');localStorage.setItem('theme',d?'light':'dark');
}
function abrirTab(id){
    document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    const t=document.getElementById('tab-'+id);if(t)t.classList.add('active');
    const btns=document.querySelectorAll('.tab-btn');
    btns.forEach(b=>{if(b.getAttribute('onclick').includes(id))b.classList.add('active');});
}
function fecharModal(id){document.getElementById(id).classList.remove('active');}

function renderLocacoes(){
    const tb=DOM.get('tblLocacoes');if(!tb)return;
    const lts=locacoes.map(l=>{
        let st=l.status;
        if(st==='ativo'&&l.dataDevolucaoPrevisao&&new Date(l.dataDevolucaoPrevisao)<new Date().setHours(0,0,0,0))st='atrasado';
        let tot=0;(l.items||[]).forEach(i=>tot+=(i.valor||0)*(i.quantidade||1));
        return {...l,statusVisual:st,valorTotal:tot/(l.divisorFatura||1)};
    });
    const fils=lts.filter(l=>filtroAtual==='todos'||l.statusVisual===filtroAtual).sort((a,b)=>b.id-a.id);
    const pag=fils.slice((paginaAtual.locacoes-1)*ITENS_POR_PAGINA, paginaAtual.locacoes*ITENS_POR_PAGINA);
    
    if(!pag.length){tb.innerHTML='<tr><td colspan="5" style="text-align:center">Sem registros.</td></tr>';return;}
    
    tb.innerHTML=pag.map(l=>{
        const c=locadores.find(x=>x.id===l.locadorId);
        return `<tr><td><b>${c?c.nome:'Exclu√≠do'}</b><br><small>#${l.id.toString().slice(-4)}</small></td><td>${formatarData(l.dataAluguel)}<br><small>At√© ${formatarData(l.dataDevolucaoPrevisao)}</small></td><td>R$ ${l.valorTotal.toFixed(2)}</td><td><span class="badge badge-${l.statusVisual==='ativo'?'success':l.statusVisual==='atrasado'?'danger':'info'}">${l.statusVisual}</span></td><td class="col-actions"><button class="btn btn-sm btn-info" onclick="gerarRelatorio(${l.id})"><i class="bi bi-file-text"></i></button>${l.status!=='devolvido'?`<button class="btn btn-sm btn-danger" onclick="cancelarLocacao(${l.id})"><i class="bi bi-trash"></i></button>`:''}</td></tr>`;
    }).join('');
}

function renderLocadores(){
    const tb=DOM.get('tblLocadores'),term=(DOM.get('buscaCliente')?.value||'').toLowerCase();if(!tb)return;
    const fils=locadores.filter(c=>c.nome.toLowerCase().includes(term));
    tb.innerHTML=fils.map(c=>`<tr><td><b>${c.nome}</b><br><small>${c.documento||''}</small></td><td>${c.email||'-'}</td><td>${c.telefone||'-'}</td><td class="col-actions"><button class="btn btn-info btn-sm" onclick="abrirEditarLocador(${c.id})"><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm" onclick="removerItem('locadores',${c.id})"><i class="bi bi-trash"></i></button></td></tr>`).join('');
}

function renderEstoque(){
    const tb=DOM.get('tblEstoque'),term=(DOM.get('buscaEstoque')?.value||'').toLowerCase();if(!tb)return;
    const fils=pecas.filter(p=>p.nome.toLowerCase().includes(term)||p.codigo.toLowerCase().includes(term));
    tb.innerHTML=fils.map(p=>`<tr><td><input type="checkbox" class="chk-estoque" data-id="${p.id}" onchange="onSelectEstoque(${p.id},this.checked)" ${(estoqueSelecionados.has(p.id))?'checked':''}></td><td><i class="bi bi-box"></i></td><td>${p.codigo}</td><td>${tipos.find(t=>t.id===p.tipoId)?.nome||'-'}</td><td><b>${p.nome}</b></td><td>R$ ${Number(p.valor).toFixed(2)}</td><td><span style="color:${p.disponivel<1?'red':'inherit'}">${p.disponivel}</span>/${p.quantidade}</td><td class="col-actions"><button class="btn btn-info btn-sm" onclick="abrirEditarPeca(${p.id})"><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm" onclick="removerItem('pecas',${p.id})"><i class="bi bi-trash"></i></button></td></tr>`).join('');
}

function renderDevolucoes(){
    const tb=document.getElementById('tblDevolucoes');if(!tb)return;
    const l=devolucoes.slice().reverse().slice(0,20);
    if(!l.length){tb.innerHTML='<tr><td colspan="4" style="text-align:center">Nenhuma devolu√ß√£o recente.</td></tr>';return;}
    tb.innerHTML=l.map(d=>{
        const loc=locacoes.find(x=>x.id===d.locacaoId),cli=locadores.find(x=>x.id===(loc?loc.locadorId:0));
        return `<tr><td>${cli?cli.nome:'?'}</td><td>${formatarData(d.dataDevolucao)}</td><td><span class="badge badge-success">OK</span></td><td><button class="btn btn-sm btn-secondary" onclick="gerarRecibo(${loc?loc.id:0})"><i class="bi bi-printer"></i></button></td></tr>`;
    }).join('');
}

function renderTipos(){
    const tb=document.getElementById('tblTipos');if(!tb)return;
    tb.innerHTML=tipos.map(t=>`<tr><td>${t.nome}</td><td>${t.desc||'-'}</td><td class="col-actions"><button class="btn btn-info btn-sm" onclick="abrirEditarTipo(${t.id})"><i class="bi bi-pencil"></i></button></td></tr>`).join('');
}

function renderStats(){
    const c=document.getElementById('dashClientes');if(c)c.innerText=locadores.length;
    const active=locacoes.filter(l=>l.status==='ativo');
    const l=document.getElementById('dashLocacoes');if(l)l.innerText=active.length;
    let rec=0;active.forEach(x=>{
        let sub=0;(x.items||[]).forEach(i=>sub+=(i.valor||0)*(i.quantidade||1));
        if(x.pago)rec+=sub/(x.divisorFatura||1);
    });
    const f=document.getElementById('dashFaturamento');if(f)f.innerText=`R$ ${rec.toFixed(2)}`;
    let atraso=0;active.forEach(x=>{if(x.dataDevolucaoPrevisao&&new Date(x.dataDevolucaoPrevisao)<new Date().setHours(0,0,0,0))atraso++;});
    const a=document.getElementById('dashAtrasos');if(a)a.innerText=atraso;
}

function updateSelects(){
    const c=document.getElementById('aluguelCliente');if(c)c.innerHTML='<option value="">Selecione...</option>'+locadores.map(x=>`<option value="${x.id}">${x.nome}</option>`).join('');
    const d=document.getElementById('devLocacao');if(d)d.innerHTML='<option value="">Selecione...</option>'+locacoes.filter(l=>l.status!=='devolvido').map(l=>`<option value="${l.id}">#${l.id.toString().slice(-4)} - ${locadores.find(x=>x.id==l.locadorId)?.nome}</option>`).join('');
    const tOpts='<option value="0">Geral</option>'+tipos.map(x=>`<option value="${x.id}">${x.nome}</option>`).join('');
    const tp=document.getElementById('pecaTipo');if(tp)tp.innerHTML=tOpts;
    const etp=document.getElementById('editPecaTipo');if(etp)etp.innerHTML=tOpts;
}
function renderConfig(){
    const r=document.getElementById('confRodape'),t=document.getElementById('confTel'),e=document.getElementById('confEmail'),l=document.getElementById('previewLogo');
    if(r)r.value=config.rodape||'';if(t)t.value=config.tel||'';if(e)e.value=config.email||'';
    if(l&&config.logo)l.innerHTML=`<img src="${config.logo}" style="height:50px">`;
}

function mostrarToast(m,t){const x=document.getElementById("toast");x.innerText=m;x.style.background=t==='erro'?'#ef4444':'#1f2937';x.className="show";setTimeout(()=>x.className="",3000);}

function addItemCarrinho(){
    const id=document.getElementById('aluguelItemSelect').value,qtd=parseInt(document.getElementById('aluguelQtd').value)||1;
    if(!id)return mostrarToast('Selecione um item','erro');
    const p=pecas.find(x=>x.id==id);if(!p)return;
    const exist=carrinhoLocacao.find(x=>x.pecaId==p.id);
    const req=qtd+(exist?exist.quantidade:0);
    if(req>p.disponivel)return mostrarToast('Estoque insuficiente','erro');
    if(exist)exist.quantidade+=qtd;else carrinhoLocacao.push({pecaId:p.id,nome:p.nome,valor:p.valor,quantidade:qtd});
    atualizarCarrinhoHTML();mostrarToast('Item adicionado');
    document.getElementById('inputBuscaPeca').value='';document.getElementById('aluguelItemSelect').value='';document.getElementById('aluguelQtd').value=1;
}
function atualizarCarrinhoHTML(){
    const div=document.getElementById('carrinhoList');
    div.innerHTML=carrinhoLocacao.map(i=>`<div class="item-carrinho"><span><b>${i.quantidade}x</b> ${i.nome}</span><span>R$ ${(i.valor*i.quantidade).toFixed(2)}</span></div>`).join('')||'<i>Vazio</i>';
}
function finalizarLocacao(){
    const cli=document.getElementById('aluguelCliente').value,ini=document.getElementById('aluguelIni').value,fim=document.getElementById('aluguelFim').value;
    if(!cli||!carrinhoLocacao.length)return mostrarToast('Preencha tudo','erro');
    locacoes.push({id:Date.now(),locadorId:parseInt(cli),dataAluguel:ini,dataDevolucaoPrevisao:fim,items:[...carrinhoLocacao],status:'ativo',divisorFatura:parseFloat(document.getElementById('aluguelDivisor').value)||1});
    carrinhoLocacao=[];atualizarCarrinhoHTML();salvarLocal();renderTudo();mostrarToast('Sucesso');
}

function salvarLocador(){const n=document.getElementById('locNome').value;if(n){locadores.push({id:Date.now(),nome:n,email:document.getElementById('locEmail').value,telefone:document.getElementById('locTel').value,documento:document.getElementById('locDoc').value});salvarLocal();renderTudo();mostrarToast('Salvo');}}
function salvarPeca(){const n=document.getElementById('pecaNome').value;if(n){pecas.push({id:Date.now(),nome:n,codigo:document.getElementById('pecaCod').value,valor:parseFloat(document.getElementById('pecaValor').value),quantidade:parseInt(document.getElementById('pecaQtd').value),disponivel:parseInt(document.getElementById('pecaQtd').value),tipoId:parseInt(document.getElementById('pecaTipo').value),medida:document.getElementById('pecaMedida').value});salvarLocal();renderTudo();mostrarToast('Salvo');}}
function salvarTipo(){const n=document.getElementById('tipoNome').value;if(n){tipos.push({id:Date.now(),nome:n,desc:document.getElementById('tipoDesc').value});salvarLocal();renderTudo();mostrarToast('Salvo');}}

function removerItem(t,id){
    if(!confirm('Certeza?'))return;
    if(t==='locadores')locadores=locadores.filter(x=>x.id!==id);
    if(t==='pecas')pecas=pecas.filter(x=>x.id!==id);
    if(t==='locacoes')locacoes=locacoes.filter(x=>x.id!==id);
    salvarLocal();renderTudo();mostrarToast('Removido');
}
function cancelarLocacao(id){removerItem('locacoes',id);}

function gisLoaded(){tokenClient=google.accounts.oauth2.initTokenClient({client_id:GOOGLE_CLIENT_ID,scope:'https://www.googleapis.com/auth/drive.file',callback:(r)=>{if(r.error)alert(r);localStorage.setItem('gToken',r.access_token);entrarApp();sincronizar('carregar');}});}
function fazerLoginGoogle(){if(tokenClient)tokenClient.requestAccessToken({prompt:'consent'});else if(window.google)gisLoaded();}
function entrarOffline(){entrarApp();document.getElementById('syncText').innerText="Offline";}
function entrarApp(){document.getElementById('loginArea').style.display='none';document.getElementById('appArea').style.display='block';renderTudo();}
function sair(){localStorage.removeItem('gToken');location.reload();}

async function sincronizar(m){
    if(!navigator.onLine){updStatus('offline');return;}
    updStatus('saving');
    try{
        if(m==='carregar'){
            const r=await fetch(`${API_URL}?action=carregar`),t=await r.text();
            if(!t.startsWith('{')){updStatus('offline');return;}
            const d=JSON.parse(t);
            locadores=d.locadores||[];pecas=d.pecas||[];locacoes=d.locacoes||[];devolucoes=d.devolucoes||[];tipos=d.tipos||[];config=d.config||config;
            salvarLocal();renderTudo();
        }else{
            await fetch(API_URL,{method:'POST',body:new URLSearchParams({dados:JSON.stringify({locadores,pecas,locacoes,devolucoes,tipos,config})})});
        }
        updStatus('online');
    }catch(e){updStatus('offline');}
}
function updStatus(s){
    const b=document.getElementById('syncBadge'),t=document.getElementById('syncText');
    if(!b)return;
    if(s==='online'){b.className="sync-badge sync-online";t.innerText="Online";}
    else if(s==='saving'){b.className="sync-badge sync-saving";t.innerText="Salvando...";}
    else {b.className="sync-badge sync-offline";t.innerText="Offline";}
}

function salvarLocal(){
    try{localStorage.setItem('mtzBackup',JSON.stringify({locadores,pecas,locacoes,devolucoes,tipos,config,logsAuditoria}));}catch(e){alert('Erro ao salvar local (Quota)');}
}
function carregarLocal(){
    try{const j=localStorage.getItem('mtzBackup');if(j){const d=JSON.parse(j);locadores=d.locadores||[];pecas=d.pecas||[];locacoes=d.locacoes||[];devolucoes=d.devolucoes||[];tipos=d.tipos||[];config=d.config||config;logsAuditoria=d.logsAuditoria||[];}}catch(e){console.log('Reset');}
}

// EDI√á√ÉO
function abrirEditarLocador(id){const c=locadores.find(x=>x.id===id);if(c){document.getElementById('editLocId').value=c.id;document.getElementById('editLocNome').value=c.nome;document.getElementById('modalEditarLocador').classList.add('active');}}
function salvarEdicaoLocador(){const id=parseInt(document.getElementById('editLocId').value),c=locadores.find(x=>x.id===id);if(c){c.nome=document.getElementById('editLocNome').value;salvarLocal();renderTudo();fecharModal('modalEditarLocador');}}

function abrirEditarPeca(id){const p=pecas.find(x=>x.id===id);if(p){document.getElementById('editPecaId').value=p.id;document.getElementById('editPecaNome').value=p.nome;document.getElementById('editPecaQtd').value=p.quantidade;document.getElementById('modalEditarPeca').classList.add('active');}}
function salvarEdicaoPeca(){const id=parseInt(document.getElementById('editPecaId').value),p=pecas.find(x=>x.id===id);if(p){p.nome=document.getElementById('editPecaNome').value;p.quantidade=parseInt(document.getElementById('editPecaQtd').value);salvarLocal();renderTudo();fecharModal('modalEditarPeca');}}

function abrirEditarTipo(id){const t=tipos.find(x=>x.id===id);if(t){document.getElementById('editTipoId').value=t.id;document.getElementById('editTipoNome').value=t.nome;document.getElementById('modalEditarTipo').classList.add('active');}}
function salvarEdicaoTipo(){const id=parseInt(document.getElementById('editTipoId').value),t=tipos.find(x=>x.id===id);if(t){t.nome=document.getElementById('editTipoNome').value;salvarLocal();renderTudo();fecharModal('modalEditarTipo');}}

// OUTROS
function atualizarLimiteEstoque(){
    const id=document.getElementById('aluguelItemSelect').value,p=pecas.find(x=>x.id==id);
    if(p)document.getElementById('aluguelQtd').max=p.disponivel;
}
function validarDigitacao(i){if(i.max&&parseInt(i.value)>parseInt(i.max))i.value=i.max;}

// ESTOQUE CHECKBOX
let estoqueSelecionados=new Set();
function onSelectEstoque(id,chk){chk?estoqueSelecionados.add(id):estoqueSelecionados.delete(id);}
function toggleSelecionarTodosEstoque(chk){document.querySelectorAll('.chk-estoque').forEach(c=>{c.checked=chk;onSelectEstoque(c.dataset.id,chk)});}
function excluirSelecionadosEstoque(){
    if(!estoqueSelecionados.size)return;
    if(!confirm('Excluir selecionados?'))return;
    pecas=pecas.filter(p=>!estoqueSelecionados.has(p.id));estoqueSelecionados.clear();salvarLocal();renderEstoque();mostrarToast('Exclu√≠dos');
}

// PDF E BACKUP
function gerarPDF(){
    const e=document.getElementById('printArea');
    html2canvas(e,{scale:2}).then(c=>{
        const i=c.toDataURL('image/png'),p=new window.jspdf.jsPDF('p','mm','a4');
        p.addImage(i,'PNG',0,0,210,(c.height*210)/c.width);p.save('doc.pdf');
    });
}
function baixarBackup(){
    const b=new Blob([JSON.stringify({locadores,pecas,locacoes,devolucoes,tipos,config})],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='backup.json';a.click();
}
function restaurarBackup(i){
    if(!i.files[0])return;
    const r=new FileReader();
    r.onload=e=>{
        const d=JSON.parse(e.target.result);
        locadores=d.locadores||[];pecas=d.pecas||[];locacoes=d.locacoes||[];tipos=d.tipos||[];config=d.config||config;
        salvarLocal();renderTudo();alert('Restaurado');
    };
    r.readAsText(i.files[0]);
}
function arquivarHistorico(){
    devolucoes=devolucoes.filter(d=>locacoes.some(l=>l.id===d.locacaoId));
    locacoes=locacoes.filter(l=>l.status!=='devolvido');salvarLocal();renderTudo();mostrarToast('Arquivado');
}

// SCANNER E PREVIEWS
function iniciarScanner(m){
    const md=document.getElementById('modalScanner');md.classList.add('active');
    Quagga.init({inputStream:{name:"Live",type:"LiveStream",target:document.querySelector('#interactive')},decoder:{readers:["code_128_reader"]}},e=>{
        if(!e)Quagga.start();
    });
    Quagga.onDetected(r=>{
        const c=r.codeResult.code;
        if(m==='cadastro')document.getElementById('pecaBar').value=c;
        if(m==='locacao'){const p=pecas.find(x=>x.codigo===c);if(p){document.getElementById('aluguelItemSelect').value=p.id;mostrarToast('Item: '+p.nome);}}
        fecharScanner();
    });
}
function fecharScanner(){document.getElementById('modalScanner').classList.remove('active');try{Quagga.stop();}catch(e){}}
function converterLogo(){const i=document.getElementById('confLogo');if(i.files[0]){const r=new FileReader();r.onload=()=>{config.logo=r.result;renderConfig();};r.readAsDataURL(i.files[0]);}}
function gerarRelatorio(id){
    const l=locacoes.find(x=>x.id===id),c=locadores.find(x=>x.id===l.locadorId);
    if(!l)return;
    const h=`<div style="padding:20px; font-family:sans-serif;"><h2>MTZ Eventos - Contrato #${l.id}</h2><p>Cliente: ${c?c.nome:'-'}</p><hr><h3>Itens:</h3><ul>${l.items.map(i=>`<li>${i.quantidade}x ${i.nome}</li>`).join('')}</ul></div>`;
    document.getElementById('printArea').innerHTML=h;document.getElementById('modalRelatorio').classList.add('active');
}
</script>
</body>
</html>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    /* === ESTILO V9: CLEAN & MODERN === */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    :root {
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --bg: #e2e8f0; 
        --surface: #ffffff;
        --surface-hover: #f8fafc;
        --text: #0f172a;
        --text-light: #64748b;
        --border: #cbd5e1;
        --input-bg: #f1f5f9;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --radius: 12px;
    }

    [data-theme="dark"] {
        --primary: #60a5fa;
        --primary-hover: #3b82f6;
        --bg: #0f172a; 
        --surface: #1e293b; 
        --surface-hover: #334155;
        --text: #f8fafc;
        --text-light: #94a3b8;
        --border: #334155;
        --input-bg: #0f172a;
        --shadow: none;
    }

    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; -webkit-font-smoothing: antialiased; }
    * { box-sizing: border-box; }

    /* CONTAINERS & CARDS */
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .card, .dash-section, .modal-content, .login-box {
        background: var(--surface) !important;
        border: none; 
        box-shadow: var(--shadow);
        border-radius: var(--radius);
        color: var(--text);
        padding: 25px;
        margin-bottom: 24px;
    }

    /* LOGIN */
    #loginArea { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .login-box { width: 100%; max-width: 400px; text-align: center; }

    /* HEADER */
    header .container { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }
    .logo h1 { font-size: 1.6rem; color: var(--text) !important; margin: 0; }

    /* INPUTS MODERNOS */
    .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
    .form-group { flex: 1; display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 0.85rem; font-weight: 600; color: var(--text-light); margin-left: 2px; }
    input, select {
        background: var(--input-bg);
        color: var(--text);
        border: 1px solid transparent; padding: 12px 15px;
        border-radius: 10px; width: 100%; outline: none; transition: 0.2s; font-size: 0.95rem;
    }
    input:focus, select:focus { background: var(--surface); border-color: var(--primary); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); }

    /* TABELAS */
    .table-responsive { border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
    .table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .table th { background: var(--surface-hover); color: var(--text-light); padding: 14px 20px; text-transform: uppercase; font-size: 0.75rem; font-weight: 700; border-bottom: 1px solid var(--border); text-align: left; }
    .table td { padding: 16px 20px; vertical-align: middle; color: var(--text); border-bottom: 1px solid var(--border); }
    .table tbody tr:hover { background-color: var(--surface-hover); }
    .col-actions { text-align: right !important; width: 1%; white-space: nowrap; }
    .actions-cell { display: flex; justify-content: flex-end; gap: 8px; }

    /* BOT√ïES & BADGES */
    .btn { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: 0.2s; }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.05); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-info { background: #0ea5e9; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; }
    
    .badge { padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-warning { background: #fef9c3; color: #854d0e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #e0f2fe; color: #075985; }

    /* DASHBOARD */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .stat-card { display: flex; align-items: center; justify-content: space-between; padding: 25px; position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-3px); }
    .stat-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
    .card-blue::before { background: #3b82f6; } .card-blue .stat-icon { background: #eff6ff; color: #3b82f6; }
    .card-orange::before { background: #f59e0b; } .card-orange .stat-icon { background: #fffbeb; color: #f59e0b; }
    .card-green::before { background: #10b981; } .card-green .stat-icon { background: #ecfdf5; color: #10b981; }
    .card-purple::before { background: #8b5cf6; } .card-purple .stat-icon { background: #f5f3ff; color: #8b5cf6; }
    .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }

    /* TABS */
    .tabs-container { width: 100%; display: flex; justify-content: flex-start; }
    .tabs { width: 100%; display: flex; justify-content: flex-start; align-items: center; gap: 5px; overflow-x: auto; padding: 5px; background: var(--surface); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 25px; box-sizing: border-box; }
    .tab-btn { flex: 0 0 auto; background: transparent; border: none; padding: 10px 20px; color: var(--text-light); font-weight: 600; cursor: pointer; border-radius: 8px; white-space: nowrap; }
    .tab-btn.active { background: var(--primary); color: white; }
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* OUTROS */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 5000; align-items: center; justify-content: center; padding: 20px; }
    .modal.active { display: flex; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
    .modal-header h3 { margin: 0; font-size: 1.2rem; }
    .btn-close-modal { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 1rem; }
    
    .sync-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; gap: 6px; text-transform: uppercase; }
    .sync-online { background: #dcfce7; color: #166534; }
    .sync-offline { background: #f1f5f9; color: #475569; }
    .sync-saving { background: #fff7ed; color: #9a3412; }
    
    #toast { visibility: hidden; min-width: 250px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 6000; left: 50%; bottom: 30px; transform: translateX(-50%); opacity: 0; transition: 0.3s; }
    #toast.show { visibility: visible; bottom: 40px; opacity: 1; }

    /* CARRINHO */
    .box-carrinho { background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    [data-theme="dark"] .box-carrinho { background: rgba(0, 0, 0, 0.2); border: 1px solid #334155; }
    .item-carrinho { display: flex; justify-content: space-between; background: var(--surface-hover); padding: 8px 12px; border-radius: 6px; border-left: 3px solid var(--primary); margin-bottom: 5px; }

    /* AUTOCOMPLETE */
    .dropdown-sugestoes { display: none; position: absolute; background: var(--surface); width: 100%; max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 0 0 10px 10px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .dropdown-sugestoes.ativo { display: block; }
    .sugestao-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
    .sugestao-item:hover { background: var(--surface-hover); }

    /* MOBILE */
    @media (max-width: 768px) {
        .container { padding: 15px; padding-bottom: 80px; }
        header .container { flex-direction: column; gap: 15px; align-items: stretch; text-align: center; }
        .form-row { flex-direction: column; gap: 15px; }
        .dashboard-grid { grid-template-columns: 1fr; }
        .modal-content { width: 100%; max-width: 100%; border-radius: 20px 20px 0 0; margin: 0; max-height: 90vh; overflow-y: auto; }
    }
</style>
</head>
<body>

    <div id="loginArea">
        <div class="login-box">
            <h1 style="color:var(--primary); margin-bottom:5px;">MTZ Eventos</h1>
            <p style="margin-bottom: 30px; color:var(--text-light);">Sistema de Gest√£o & Loca√ß√£o V11</p>
            
            <button id="btnLoginGoogle" class="btn" style="width: 100%; margin-bottom: 15px; background-color: #1e293b; color: white; justify-content: center; padding: 14px;" onclick="fazerLoginGoogle()">
                <i class="bi bi-google"></i> Entrar com Google
            </button>
            <button class="btn" style="width: 100%; background-color: var(--primary); color: white; justify-content: center; padding: 14px;" onclick="entrarOffline()">
                <i class="bi bi-hdd"></i> Usar Offline (Local)
            </button>
        </div>
    </div>

    <div id="appArea" style="display: none;">
        <header>
            <div class="container">
                <div class="logo">
                    <h1>MTZ Eventos</h1>
                    <p style="font-size:0.85rem; color:var(--text-light);">Painel de Controle</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div id="syncBadge" class="sync-badge sync-offline"><i class="bi bi-circle-fill"></i> <span id="syncText">Offline</span></div>
                    <button class="btn btn-secondary btn-sm" onclick="toggleTheme()"><i class="bi bi-moon"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="sair()"><i class="bi bi-box-arrow-right"></i></button>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab-btn active" onclick="abrirTab('dashboard')"><i class="bi bi-grid"></i> Dashboard</button>
                    <button class="tab-btn" onclick="abrirTab('locadores')"><i class="bi bi-people"></i> Clientes</button>
                    <button class="tab-btn" onclick="abrirTab('tipos')"><i class="bi bi-tags"></i> Tipos</button>
                    <button class="tab-btn" onclick="abrirTab('estoque')"><i class="bi bi-box-seam"></i> Estoque</button>
                    <button class="tab-btn" onclick="abrirTab('locacoes')"><i class="bi bi-cart"></i> Loca√ß√µes</button>
                    <button class="tab-btn" onclick="abrirTab('devolucoes')"><i class="bi bi-arrow-return-left"></i> Devolu√ß√µes</button>
                    <button class="tab-btn" onclick="abrirTab('auditoria')"><i class="bi bi-shield-check"></i> Auditoria</button>
                    <button class="tab-btn" onclick="abrirTab('config')"><i class="bi bi-gear"></i> Config</button>
                </div>
            </div>

            <div id="tab-dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card card-blue" onclick="abrirTab('locadores')">
                        <div class="stat-info"><h3 id="dashClientes">0</h3><p>Clientes</p></div>
                        <div class="stat-icon"><i class="bi bi-people"></i></div>
                    </div>
                    <div class="stat-card card-orange" onclick="irParaLocacoes('todos')">
                        <div class="stat-info"><h3 id="dashLocacoes">0</h3><p>Loca√ß√µes Ativas</p></div>
                        <div class="stat-icon"><i class="bi bi-cart"></i></div>
                    </div>
                    <div class="stat-card card-green">
                        <div class="stat-info"><h3 id="dashFaturamento" style="font-size:1.4rem;">R$ 0,00</h3><p>Receita</p></div>
                        <div class="stat-icon"><i class="bi bi-currency-dollar"></i></div>
                    </div>
                    <div class="stat-card card-purple" onclick="irParaLocacoes('atrasado')">
                        <div class="stat-info"><h3 id="dashAtrasos">0</h3><p>Atrasos</p></div>
                        <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    </div>
                </div>
                <div class="dash-section">
                    <h3><i class="bi bi-calendar-event"></i> Pr√≥ximas Devolu√ß√µes</h3>
                    <div class="table-responsive">
                        <table class="table"><thead><tr><th>Data</th><th>Cliente</th><th style="text-align:center">Status</th></tr></thead><tbody id="tblDashDevolucoes"></tbody></table>
                    </div>
                </div>
            </div>

            <div id="tab-locadores" class="tab-content">
                <div class="card">
                    <h3>Novo Cliente</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Nome Completo</label><input type="text" id="locNome"></div>
                        <div class="form-group"><label>CPF / CNPJ</label><input type="text" id="locDoc"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Email</label><input type="email" id="locEmail"></div>
                        <div class="form-group"><label>Telefone</label><input type="tel" id="locTel"></div>
                    </div>
                    <button class="btn btn-primary" onclick="salvarLocador()">Cadastrar</button>
                </div>
                <div class="card">
                    <input type="text" id="buscaCliente" placeholder="üîç Buscar cliente..." onkeyup="buscarComDebounce('locadores')" style="margin-bottom: 15px;">
                    <div class="table-responsive"><table class="table"><tbody id="tblLocadores"></tbody></table></div>
                </div>
            </div>

            <div id="tab-tipos" class="tab-content">
                <div class="card">
                    <h3>Novo Tipo</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Nome</label><input type="text" id="tipoNome"></div>
                        <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="tipoDesc"></div>
                    </div>
                    <button class="btn btn-primary" onclick="salvarTipo()">Salvar</button>
                </div>
                <div class="card"><div class="table-responsive"><table class="table"><tbody id="tblTipos"></tbody></table></div></div>
            </div>

            <div id="tab-estoque" class="tab-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h2 style="margin:0;">Stock</h2>
                    <button class="btn btn-success" onclick="document.getElementById('inputExcel').click()">Importar Excel</button>
                </div>
                <input type="file" id="inputExcel" accept=".xlsx, .xls" style="display:none" onchange="processarExcelInteligente(this)">
                
                <div class="card">
                    <h3>Novo Item</h3>
                    <div class="form-row">
                        <div class="form-group"><label>C√≥digo</label><input type="text" id="pecaCod"></div>
                        <div class="form-group"><label>Categoria</label><select id="pecaTipo"></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Nome</label><input type="text" id="pecaNome"></div>
                        <div class="form-group"><label>Medida</label><input type="text" id="pecaMedida"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Valor (R$)</label><input type="number" id="pecaValor" step="0.01"></div>
                        <div class="form-group"><label>Qtd</label><input type="number" id="pecaQtd" value="1"></div>
                        <div class="form-group"><label>C√≥d Barras</label><div style="display:flex; gap:5px;"><input type="text" id="pecaBar"><button class="btn btn-secondary" onclick="iniciarScanner('cadastro')"><i class="bi bi-qr-code"></i></button></div></div>
                    </div>
                    <button class="btn btn-primary" onclick="salvarPeca()">Salvar Item</button>
                </div>

                <div class="card">
                    <input type="text" id="buscaEstoque" placeholder="üîç Buscar..." onkeyup="buscarComDebounce('estoque')" style="margin-bottom:12px;">
                    <div style="margin-bottom:12px;"><button class="btn btn-danger btn-sm" onclick="excluirSelecionadosEstoque()">Excluir selecionados</button></div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th style="width:40px;"><input type="checkbox" id="chkAllEstoque" onchange="toggleSelecionarTodosEstoque(this.checked)"></th><th>Img</th><th>C√≥d</th><th>Tipo</th><th>Nome</th><th>Valor</th><th>Estoque</th><th class="col-actions">A√ß√µes</th></tr></thead>
                            <tbody id="tblEstoque"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-locacoes" class="tab-content">
                <div class="card">
                    <h3>Nova Loca√ß√£o</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Cliente</label><select id="aluguelCliente"></select></div>
                        <div class="form-group"><label>Divisor</label><input type="number" id="aluguelDivisor" value="0.8367"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>In√≠cio</label><input type="date" id="aluguelIni"></div>
                        <div class="form-group"><label>Fim</label><input type="date" id="aluguelFim"></div>
                    </div>

                    <div class="box-carrinho">
                        <h4><i class="bi bi-cart-plus"></i> Itens</h4>
                        <div class="form-row" style="align-items:flex-end;">
                            <div class="form-group" style="flex:4; position:relative;">
                                <label>Buscar Item</label>
                                <input type="text" id="inputBuscaPeca" onkeyup="filtrarItensLocacao()" autocomplete="off">
                                <input type="hidden" id="aluguelItemSelect">
                                <div id="listaSugestoes" class="dropdown-sugestoes"></div>
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label>Qtd</label>
                                <input type="number" id="aluguelQtd" value="1" style="text-align:center;" oninput="validarDigitacao(this)">
                            </div>
                            <div class="form-group" style="flex:2; flex-direction:row;">
                                <button class="btn btn-success" style="flex:1;" onclick="addItemCarrinho()">Add</button>
                                <button class="btn btn-secondary" style="width:50px;" onclick="iniciarScanner('locacao')"><i class="bi bi-qr-code"></i></button>
                            </div>
                        </div>
                        <div id="carrinhoList"><i>Nenhum item adicionado.</i></div>
                    </div>
                    <button class="btn btn-primary" onclick="finalizarLocacao()">Concluir</button>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:15px; overflow-x:auto;">
                    <button class="btn btn-sm btn-secondary" onclick="mudarFiltro('todos')">Todos</button>
                    <button class="btn btn-sm btn-success" onclick="mudarFiltro('ativo')">Em Aberto</button>
                    <button class="btn btn-sm btn-danger" onclick="mudarFiltro('atrasado')">Atrasados</button>
                    <button class="btn btn-sm btn-info" onclick="mudarFiltro('devolvido')">Hist√≥rico</button>
                </div>
                <div class="card">
                    <div class="table-responsive"><table class="table"><tbody id="tblLocacoes"></tbody></table></div>
                </div>
            </div>

            <div id="tab-devolucoes" class="tab-content">
                <div class="card">
                    <h3>Registrar Devolu√ß√£o</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Loca√ß√£o</label><select id="devLocacao" onchange="carregarItensDevolucao()"></select></div>
                        <div class="form-group"><label>Data</label><input type="date" id="devData"></div>
                    </div>
                    <div id="divItensDevolucao" style="margin:15px 0; padding:15px; border:1px solid var(--border); border-radius:8px;"></div>
                    <button class="btn btn-primary" onclick="confirmarDevolucao()">Confirmar Baixa</button>
                </div>
                <div class="card">
                    <h3>Hist√≥rico</h3>
                    <div class="table-responsive"><table class="table"><tbody id="tblDevolucoes"></tbody></table></div>
                </div>
            </div>

            <div id="tab-auditoria" class="tab-content">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h3>Auditoria</h3>
                        <div>
                            <button class="btn btn-info btn-sm" onclick="exportarLogsCSV()">Exportar</button>
                            <button class="btn btn-danger btn-sm" onclick="if(confirm('Limpar?')) limparLogsAntigos()">Limpar</button>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:15px; overflow-x:auto;">
                        <button class="btn btn-sm btn-secondary" onclick="renderLogs('todos')">Todos</button>
                        <button class="btn btn-sm btn-success" onclick="renderLogs('cliente')">Clientes</button>
                        <button class="btn btn-sm btn-success" onclick="renderLogs('item')">Itens</button>
                        <button class="btn btn-sm btn-warning" onclick="renderLogs('locacao')">Loca√ß√µes</button>
                    </div>
                    <div class="table-responsive"><table class="table"><tbody id="tblLogs"></tbody></table></div>
                </div>
            </div>

            <div id="tab-config" class="tab-content">
                <div class="card">
                    <h3>Personaliza√ß√£o</h3>
                    <div class="form-row"><div class="form-group"><label>Rodap√© PDF</label><input type="text" id="confRodape"></div></div>
                    <div class="form-row">
                        <div class="form-group"><label>Telefone</label><input type="text" id="confTel"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="confEmail"></div>
                    </div>
                    <div class="form-group"><label>Logo</label><input type="file" id="confLogo" onchange="converterLogo()"></div>
                    <div id="previewLogo" style="margin:10px 0;"></div>
                    <button class="btn btn-primary" onclick="salvarConfig()">Salvar</button>
                </div>
                <div class="card">
                    <h3>Backup</h3>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-info" onclick="baixarBackup()">Baixar JSON</button>
                        <button class="btn btn-warning" onclick="document.getElementById('fileRestore').click()">Restaurar JSON</button>
                        <button class="btn btn-danger" onclick="arquivarHistorico()">Limpeza</button>
                        <input type="file" id="fileRestore" style="display:none;" onchange="restaurarBackup(this)">
                    </div>
                </div>
            </div>
        </div> </div> <div id="modalEditarLocador" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar Cliente</h3><button class="btn-close-modal" onclick="fecharModal('modalEditarLocador')">X</button></div>
            <input type="hidden" id="editLocId">
            <div class="form-group"><label>Nome</label><input type="text" id="editLocNome"></div>
            <div class="form-group"><label>Email</label><input type="email" id="editLocEmail"></div>
            <div class="form-group"><label>Telefone</label><input type="tel" id="editLocTel"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="salvarEdicaoLocador()">Salvar</button>
        </div>
    </div>

    <div id="modalEditarPeca" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar Item</h3><button class="btn-close-modal" onclick="fecharModal('modalEditarPeca')">X</button></div>
            <input type="hidden" id="editPecaId">
            <div class="form-row">
                <div class="form-group"><label>C√≥digo</label><input type="text" id="editPecaCod"></div>
                <div class="form-group"><label>Tipo</label><select id="editPecaTipo"></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Nome</label><input type="text" id="editPecaNome"></div>
                <div class="form-group"><label>Valor</label><input type="number" id="editPecaValor" step="0.01"></div>
            </div>
            <div class="form-group"><label>Qtd</label><input type="number" id="editPecaQtd"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="salvarEdicaoPeca()">Salvar</button>
        </div>
    </div>

    <div id="modalEditarTipo" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar Tipo</h3><button class="btn-close-modal" onclick="fecharModal('modalEditarTipo')">X</button></div>
            <input type="hidden" id="editTipoId">
            <div class="form-group"><label>Nome</label><input type="text" id="editTipoNome"></div>
            <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="editTipoDesc"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="salvarEdicaoTipo()">Salvar</button>
        </div>
    </div>

    <div id="modalScanner" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Leitor QR</h3><button class="btn-close-modal" onclick="fecharScanner()">X</button></div>
            <div id="interactive" class="viewport" style="width:100%; height:250px; background:#000;"></div>
        </div>
    </div>
    
    <div id="modalRelatorio" class="modal">
        <div class="modal-content" style="max-width:900px; padding:0; height:90vh; display:flex; flex-direction:column;">
            <div style="padding:15px; background:#333; color:white; display:flex; justify-content:space-between;">
                <span>Impress√£o</span>
                <div>
                    <button class="btn btn-primary btn-sm" onclick="gerarPDF()">PDF</button>
                    <button class="btn btn-danger btn-sm" onclick="fecharModal('modalRelatorio')">Fechar</button>
                </div>
            </div>
            <div style="flex:1; overflow-y:auto; padding:20px; background:#555; display:flex; justify-content:center;">
                <div id="printArea" class="invoice-box"></div>
            </div>
        </div>
    </div>

    <div id="toast"></div>

<script>
const DOM={_cache:{},get(e){return this._cache[e]||(this._cache[e]=document.getElementById(e)),this._cache[e]}};
let locadores=[],pecas=[],locacoes=[],devolucoes=[],tipos=[],carrinhoLocacao=[],logsAuditoria=[];
let config={rodape:"MTZ Eventos",tel:"",email:"",logo:""},tokenClient,filtroAtual='todos';
let paginaAtual={locadores:1,pecas:1,locacoes:1};
const ITENS_POR_PAGINA=50;

function filtrarItensLocacao(){
    const t=document.getElementById('inputBuscaPeca'),l=document.getElementById('listaSugestoes');
    if(!t||!l)return;
    const term=t.value.toLowerCase();l.innerHTML='';
    if(term.length<2){l.classList.remove('ativo');return;}
    const fils=pecas.filter(p=>(p.nome&&p.nome.toLowerCase().includes(term))||(p.codigo&&p.codigo.toLowerCase().includes(term)));
    if(!fils.length){l.classList.remove('ativo');return;}
    fils.forEach(p=>{
        const i=document.createElement('div');i.className='sugestao-item';
        i.innerHTML=`<span>${p.nome}</span><span style="font-size:0.8rem;color:${p.disponivel>0?'var(--primary)':'red'}">(Disp: ${p.disponivel})</span>`;
        i.onclick=()=>{
            t.value=p.nome;document.getElementById('aluguelItemSelect').value=p.id;
            document.getElementById('aluguelQtd').focus();atualizarLimiteEstoque();l.classList.remove('ativo');
        };
        l.appendChild(i);
    });
    l.classList.add('ativo');
}
document.addEventListener('click',e=>{if(!e.target.closest('.form-group')){const l=document.getElementById('listaSugestoes');if(l)l.classList.remove('ativo');}});

function renderTudo(){
    if(typeof renderLocacoes==='function')renderLocacoes();
    if(typeof renderLocadores==='function')renderLocadores();
    if(typeof renderEstoque==='function')renderEstoque();
    if(typeof renderDevolucoes==='function')renderDevolucoes();
    if(typeof renderTipos==='function')renderTipos();
    if(typeof renderStats==='function')renderStats();
    if(typeof updateSelects==='function')updateSelects();
    if(typeof renderLogs==='function')renderLogs();
    if(typeof renderConfig==='function')renderConfig();
}
let cacheDisponibilidade=null,ultimaAtualizacaoCache=0;
function debounce(f,d){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>f.apply(this,a),d);}}
const buscarComDebounce=debounce(function(t){if(t==='locadores')renderLocadores();if(t==='estoque')renderEstoque();},300);

function registrarLog(t,a,d,data=null){
    const l={id:Date.now(),timestamp:new Date().toISOString(),data:new Date().toLocaleString('pt-BR'),tipo:t,acao:a,descricao:d,usuario:localStorage.getItem('usuarioEmail')||'Offline',dados:data};
    logsAuditoria.unshift(l);if(logsAuditoria.length>1000)logsAuditoria=logsAuditoria.slice(0,1000);
}
function limparLogsAntigos(){
    const limit=Date.now()-(90*24*60*60*1000);logsAuditoria=logsAuditoria.filter(l=>l.id>limit);salvarLocal();renderLogs();
}
function exportarLogsCSV(){
    if(!logsAuditoria.length)return mostrarToast('Sem logs','erro');
    let csv='Data,Hora,Tipo,Acao,Descricao\n';
    logsAuditoria.forEach(l=>{
        const d=new Date(l.timestamp);
        csv+=`"${d.toLocaleDateString()}","${d.toLocaleTimeString()}","${l.tipo}","${l.acao}","${l.descricao}"\n`;
    });
    const b=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='logs.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);
}
function renderLogs(f='todos'){
    const tb=document.getElementById('tblLogs');if(!tb)return;
    let l=logsAuditoria;if(f!=='todos')l=l.filter(x=>x.tipo===f);
    tb.innerHTML=l.slice(0,100).map(x=>`<tr><td>${new Date(x.timestamp).toLocaleString()}</td><td>${x.tipo}</td><td>${x.acao}</td><td>${x.descricao}</td><td>${x.usuario}</td></tr>`).join('');
}

const GOOGLE_CLIENT_ID='981345912804-uim8kctqnts15kt6l8odhif3hil6udek.apps.googleusercontent.com';
const API_URL='https://script.google.com/macros/s/AKfycbxZoCyJZrG2WZfIuPA3Iyz6d-PIdnzFi-Ejnl3gAUB-l9mGnBJt0BpyBErzMI_GFuZuhA/exec';

function formatarData(s){if(!s)return '---';const d=new Date(s);return isNaN(d)?'Aberta':new Date(d.getTime()+d.getTimezoneOffset()*60000).toLocaleDateString('pt-BR');}

window.onload=function(){
    carregarLocal();
    const h=new Date().toISOString().split('T')[0];
    const i=document.getElementById('aluguelIni'),d=document.getElementById('devData');
    if(i)i.value=h;if(d)d.value=h;
    if(localStorage.getItem('theme')==='dark')document.body.setAttribute('data-theme','dark');
    if(window.google)gisLoaded();
    if(localStorage.getItem('gToken'))entrarApp();
    setInterval(salvarLocal,60000);
};

function toggleTheme(){
    const b=document.body,d=b.getAttribute('data-theme')==='dark';
    b.setAttribute('data-theme',d?'light':'dark');localStorage.setItem('theme',d?'light':'dark');
}
function abrirTab(id){
    document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    const t=document.getElementById('tab-'+id);if(t)t.classList.add('active');
    const btns=document.querySelectorAll('.tab-btn');
    btns.forEach(b=>{if(b.getAttribute('onclick').includes(id))b.classList.add('active');});
}
function fecharModal(id){document.getElementById(id).classList.remove('active');}

function renderLocacoes(){
    const tb=DOM.get('tblLocacoes');if(!tb)return;
    const lts=locacoes.map(l=>{
        let st=l.status;
        if(st==='ativo'&&l.dataDevolucaoPrevisao&&new Date(l.dataDevolucaoPrevisao)<new Date().setHours(0,0,0,0))st='atrasado';
        let tot=0;(l.items||[]).forEach(i=>tot+=(i.valor||0)*(i.quantidade||1));
        return {...l,statusVisual:st,valorTotal:tot/(l.divisorFatura||1)};
    });
    const fils=lts.filter(l=>filtroAtual==='todos'||l.statusVisual===filtroAtual).sort((a,b)=>b.id-a.id);
    const pag=fils.slice((paginaAtual.locacoes-1)*ITENS_POR_PAGINA, paginaAtual.locacoes*ITENS_POR_PAGINA);
    
    if(!pag.length){tb.innerHTML='<tr><td colspan="5" style="text-align:center">Sem registros.</td></tr>';return;}
    
    tb.innerHTML=pag.map(l=>{
        const c=locadores.find(x=>x.id===l.locadorId);
        return `<tr><td><b>${c?c.nome:'Exclu√≠do'}</b><br><small>#${l.id.toString().slice(-4)}</small></td><td>${formatarData(l.dataAluguel)}<br><small>At√© ${formatarData(l.dataDevolucaoPrevisao)}</small></td><td>R$ ${l.valorTotal.toFixed(2)}</td><td><span class="badge badge-${l.statusVisual==='ativo'?'success':l.statusVisual==='atrasado'?'danger':'info'}">${l.statusVisual}</span></td><td class="col-actions"><button class="btn btn-sm btn-info" onclick="gerarRelatorio(${l.id})"><i class="bi bi-file-text"></i></button>${l.status!=='devolvido'?`<button class="btn btn-sm btn-danger" onclick="cancelarLocacao(${l.id})"><i class="bi bi-trash"></i></button>`:''}</td></tr>`;
    }).join('');
}

function renderLocadores(){
    const tb=DOM.get('tblLocadores'),term=(DOM.get('buscaCliente')?.value||'').toLowerCase();if(!tb)return;
    const fils=locadores.filter(c=>c.nome.toLowerCase().includes(term));
    tb.innerHTML=fils.map(c=>`<tr><td><b>${c.nome}</b><br><small>${c.documento||''}</small></td><td>${c.email||'-'}</td><td>${c.telefone||'-'}</td><td class="col-actions"><button class="btn btn-info btn-sm" onclick="abrirEditarLocador(${c.id})"><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm" onclick="removerItem('locadores',${c.id})"><i class="bi bi-trash"></i></button></td></tr>`).join('');
}

function renderEstoque(){
    const tb=DOM.get('tblEstoque'),term=(DOM.get('buscaEstoque')?.value||'').toLowerCase();if(!tb)return;
    const fils=pecas.filter(p=>p.nome.toLowerCase().includes(term)||p.codigo.toLowerCase().includes(term));
    tb.innerHTML=fils.map(p=>`<tr><td><input type="checkbox" class="chk-estoque" data-id="${p.id}" onchange="onSelectEstoque(${p.id},this.checked)" ${(estoqueSelecionados.has(p.id))?'checked':''}></td><td><i class="bi bi-box"></i></td><td>${p.codigo}</td><td>${tipos.find(t=>t.id===p.tipoId)?.nome||'-'}</td><td><b>${p.nome}</b></td><td>R$ ${Number(p.valor).toFixed(2)}</td><td><span style="color:${p.disponivel<1?'red':'inherit'}">${p.disponivel}</span>/${p.quantidade}</td><td class="col-actions"><button class="btn btn-info btn-sm" onclick="abrirEditarPeca(${p.id})"><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm" onclick="removerItem('pecas',${p.id})"><i class="bi bi-trash"></i></button></td></tr>`).join('');
}

function renderDevolucoes(){
    const tb=document.getElementById('tblDevolucoes');if(!tb)return;
    const l=devolucoes.slice().reverse().slice(0,20);
    if(!l.length){tb.innerHTML='<tr><td colspan="4" style="text-align:center">Nenhuma devolu√ß√£o recente.</td></tr>';return;}
    tb.innerHTML=l.map(d=>{
        const loc=locacoes.find(x=>x.id===d.locacaoId),cli=locadores.find(x=>x.id===(loc?loc.locadorId:0));
        return `<tr><td>${cli?cli.nome:'?'}</td><td>${formatarData(d.dataDevolucao)}</td><td><span class="badge badge-success">OK</span></td><td><button class="btn btn-sm btn-secondary" onclick="gerarRecibo(${loc?loc.id:0})"><i class="bi bi-printer"></i></button></td></tr>`;
    }).join('');
}

function renderTipos(){
    const tb=document.getElementById('tblTipos');if(!tb)return;
    tb.innerHTML=tipos.map(t=>`<tr><td>${t.nome}</td><td>${t.desc||'-'}</td><td class="col-actions"><button class="btn btn-info btn-sm" onclick="abrirEditarTipo(${t.id})"><i class="bi bi-pencil"></i></button></td></tr>`).join('');
}

function renderStats(){
    const c=document.getElementById('dashClientes');if(c)c.innerText=locadores.length;
    const active=locacoes.filter(l=>l.status==='ativo');
    const l=document.getElementById('dashLocacoes');if(l)l.innerText=active.length;
    let rec=0;active.forEach(x=>{
        let sub=0;(x.items||[]).forEach(i=>sub+=(i.valor||0)*(i.quantidade||1));
        if(x.pago)rec+=sub/(x.divisorFatura||1);
    });
    const f=document.getElementById('dashFaturamento');if(f)f.innerText=`R$ ${rec.toFixed(2)}`;
    let atraso=0;active.forEach(x=>{if(x.dataDevolucaoPrevisao&&new Date(x.dataDevolucaoPrevisao)<new Date().setHours(0,0,0,0))atraso++;});
    const a=document.getElementById('dashAtrasos');if(a)a.innerText=atraso;
}

function updateSelects(){
    const c=document.getElementById('aluguelCliente');if(c)c.innerHTML='<option value="">Selecione...</option>'+locadores.map(x=>`<option value="${x.id}">${x.nome}</option>`).join('');
    const d=document.getElementById('devLocacao');if(d)d.innerHTML='<option value="">Selecione...</option>'+locacoes.filter(l=>l.status!=='devolvido').map(l=>`<option value="${l.id}">#${l.id.toString().slice(-4)} - ${locadores.find(x=>x.id==l.locadorId)?.nome}</option>`).join('');
    const tOpts='<option value="0">Geral</option>'+tipos.map(x=>`<option value="${x.id}">${x.nome}</option>`).join('');
    const tp=document.getElementById('pecaTipo');if(tp)tp.innerHTML=tOpts;
    const etp=document.getElementById('editPecaTipo');if(etp)etp.innerHTML=tOpts;
}
function renderConfig(){
    const r=document.getElementById('confRodape'),t=document.getElementById('confTel'),e=document.getElementById('confEmail'),l=document.getElementById('previewLogo');
    if(r)r.value=config.rodape||'';if(t)t.value=config.tel||'';if(e)e.value=config.email||'';
    if(l&&config.logo)l.innerHTML=`<img src="${config.logo}" style="height:50px">`;
}

function mostrarToast(m,t){const x=document.getElementById("toast");x.innerText=m;x.style.background=t==='erro'?'#ef4444':'#1f2937';x.className="show";setTimeout(()=>x.className="",3000);}

function addItemCarrinho(){
    const id=document.getElementById('aluguelItemSelect').value,qtd=parseInt(document.getElementById('aluguelQtd').value)||1;
    if(!id)return mostrarToast('Selecione um item','erro');
    const p=pecas.find(x=>x.id==id);if(!p)return;
    const exist=carrinhoLocacao.find(x=>x.pecaId==p.id);
    const req=qtd+(exist?exist.quantidade:0);
    if(req>p.disponivel)return mostrarToast('Estoque insuficiente','erro');
    if(exist)exist.quantidade+=qtd;else carrinhoLocacao.push({pecaId:p.id,nome:p.nome,valor:p.valor,quantidade:qtd});
    atualizarCarrinhoHTML();mostrarToast('Item adicionado');
    document.getElementById('inputBuscaPeca').value='';document.getElementById('aluguelItemSelect').value='';document.getElementById('aluguelQtd').value=1;
}
function atualizarCarrinhoHTML(){
    const div=document.getElementById('carrinhoList');
    div.innerHTML=carrinhoLocacao.map(i=>`<div class="item-carrinho"><span><b>${i.quantidade}x</b> ${i.nome}</span><span>R$ ${(i.valor*i.quantidade).toFixed(2)}</span></div>`).join('')||'<i>Vazio</i>';
}
function finalizarLocacao(){
    const cli=document.getElementById('aluguelCliente').value,ini=document.getElementById('aluguelIni').value,fim=document.getElementById('aluguelFim').value;
    if(!cli||!carrinhoLocacao.length)return mostrarToast('Preencha tudo','erro');
    locacoes.push({id:Date.now(),locadorId:parseInt(cli),dataAluguel:ini,dataDevolucaoPrevisao:fim,items:[...carrinhoLocacao],status:'ativo',divisorFatura:parseFloat(document.getElementById('aluguelDivisor').value)||1});
    carrinhoLocacao=[];atualizarCarrinhoHTML();salvarLocal();renderTudo();mostrarToast('Sucesso');
}

function salvarLocador(){const n=document.getElementById('locNome').value;if(n){locadores.push({id:Date.now(),nome:n,email:document.getElementById('locEmail').value,telefone:document.getElementById('locTel').value,documento:document.getElementById('locDoc').value});salvarLocal();renderTudo();mostrarToast('Salvo');}}
function salvarPeca(){const n=document.getElementById('pecaNome').value;if(n){pecas.push({id:Date.now(),nome:n,codigo:document.getElementById('pecaCod').value,valor:parseFloat(document.getElementById('pecaValor').value),quantidade:parseInt(document.getElementById('pecaQtd').value),disponivel:parseInt(document.getElementById('pecaQtd').value),tipoId:parseInt(document.getElementById('pecaTipo').value),medida:document.getElementById('pecaMedida').value});salvarLocal();renderTudo();mostrarToast('Salvo');}}
function salvarTipo(){const n=document.getElementById('tipoNome').value;if(n){tipos.push({id:Date.now(),nome:n,desc:document.getElementById('tipoDesc').value});salvarLocal();renderTudo();mostrarToast('Salvo');}}

function removerItem(t,id){
    if(!confirm('Certeza?'))return;
    if(t==='locadores')locadores=locadores.filter(x=>x.id!==id);
    if(t==='pecas')pecas=pecas.filter(x=>x.id!==id);
    if(t==='locacoes')locacoes=locacoes.filter(x=>x.id!==id);
    salvarLocal();renderTudo();mostrarToast('Removido');
}
function cancelarLocacao(id){removerItem('locacoes',id);}

function gisLoaded(){tokenClient=google.accounts.oauth2.initTokenClient({client_id:GOOGLE_CLIENT_ID,scope:'https://www.googleapis.com/auth/drive.file',callback:(r)=>{if(r.error)alert(r);localStorage.setItem('gToken',r.access_token);entrarApp();sincronizar('carregar');}});}
function fazerLoginGoogle(){if(tokenClient)tokenClient.requestAccessToken({prompt:'consent'});else if(window.google)gisLoaded();}
function entrarOffline(){entrarApp();document.getElementById('syncText').innerText="Offline";}
function entrarApp(){document.getElementById('loginArea').style.display='none';document.getElementById('appArea').style.display='block';renderTudo();}
function sair(){localStorage.removeItem('gToken');location.reload();}

async function sincronizar(m){
    if(!navigator.onLine){updStatus('offline');return;}
    updStatus('saving');
    try{
        if(m==='carregar'){
            const r=await fetch(`${API_URL}?action=carregar`),t=await r.text();
            if(!t.startsWith('{')){updStatus('offline');return;}
            const d=JSON.parse(t);
            locadores=d.locadores||[];pecas=d.pecas||[];locacoes=d.locacoes||[];devolucoes=d.devolucoes||[];tipos=d.tipos||[];config=d.config||config;
            salvarLocal();renderTudo();
        }else{
            await fetch(API_URL,{method:'POST',body:new URLSearchParams({dados:JSON.stringify({locadores,pecas,locacoes,devolucoes,tipos,config})})});
        }
        updStatus('online');
    }catch(e){updStatus('offline');}
}
function updStatus(s){
    const b=document.getElementById('syncBadge'),t=document.getElementById('syncText');
    if(!b)return;
    if(s==='online'){b.className="sync-badge sync-online";t.innerText="Online";}
    else if(s==='saving'){b.className="sync-badge sync-saving";t.innerText="Salvando...";}
    else {b.className="sync-badge sync-offline";t.innerText="Offline";}
}

function salvarLocal(){
    try{localStorage.setItem('mtzBackup',JSON.stringify({locadores,pecas,locacoes,devolucoes,tipos,config,logsAuditoria}));}catch(e){alert('Erro ao salvar local (Quota)');}
}
function carregarLocal(){
    try{const j=localStorage.getItem('mtzBackup');if(j){const d=JSON.parse(j);locadores=d.locadores||[];pecas=d.pecas||[];locacoes=d.locacoes||[];devolucoes=d.devolucoes||[];tipos=d.tipos||[];config=d.config||config;logsAuditoria=d.logsAuditoria||[];}}catch(e){console.log('Reset');}
}

// EDI√á√ÉO
function abrirEditarLocador(id){const c=locadores.find(x=>x.id===id);if(c){document.getElementById('editLocId').value=c.id;document.getElementById('editLocNome').value=c.nome;document.getElementById('modalEditarLocador').classList.add('active');}}
function salvarEdicaoLocador(){const id=parseInt(document.getElementById('editLocId').value),c=locadores.find(x=>x.id===id);if(c){c.nome=document.getElementById('editLocNome').value;salvarLocal();renderTudo();fecharModal('modalEditarLocador');}}

function abrirEditarPeca(id){const p=pecas.find(x=>x.id===id);if(p){document.getElementById('editPecaId').value=p.id;document.getElementById('editPecaNome').value=p.nome;document.getElementById('editPecaQtd').value=p.quantidade;document.getElementById('modalEditarPeca').classList.add('active');}}
function salvarEdicaoPeca(){const id=parseInt(document.getElementById('editPecaId').value),p=pecas.find(x=>x.id===id);if(p){p.nome=document.getElementById('editPecaNome').value;p.quantidade=parseInt(document.getElementById('editPecaQtd').value);salvarLocal();renderTudo();fecharModal('modalEditarPeca');}}

function abrirEditarTipo(id){const t=tipos.find(x=>x.id===id);if(t){document.getElementById('editTipoId').value=t.id;document.getElementById('editTipoNome').value=t.nome;document.getElementById('modalEditarTipo').classList.add('active');}}
function salvarEdicaoTipo(){const id=parseInt(document.getElementById('editTipoId').value),t=tipos.find(x=>x.id===id);if(t){t.nome=document.getElementById('editTipoNome').value;salvarLocal();renderTudo();fecharModal('modalEditarTipo');}}

// OUTROS
function atualizarLimiteEstoque(){
    const id=document.getElementById('aluguelItemSelect').value,p=pecas.find(x=>x.id==id);
    if(p)document.getElementById('aluguelQtd').max=p.disponivel;
}
function validarDigitacao(i){if(i.max&&parseInt(i.value)>parseInt(i.max))i.value=i.max;}

// ESTOQUE CHECKBOX
let estoqueSelecionados=new Set();
function onSelectEstoque(id,chk){chk?estoqueSelecionados.add(id):estoqueSelecionados.delete(id);}
function toggleSelecionarTodosEstoque(chk){document.querySelectorAll('.chk-estoque').forEach(c=>{c.checked=chk;onSelectEstoque(c.dataset.id,chk)});}
function excluirSelecionadosEstoque(){
    if(!estoqueSelecionados.size)return;
    if(!confirm('Excluir selecionados?'))return;
    pecas=pecas.filter(p=>!estoqueSelecionados.has(p.id));estoqueSelecionados.clear();salvarLocal();renderEstoque();mostrarToast('Exclu√≠dos');
}

// PDF E BACKUP
function gerarPDF(){
    const e=document.getElementById('printArea');
    html2canvas(e,{scale:2}).then(c=>{
        const i=c.toDataURL('image/png'),p=new window.jspdf.jsPDF('p','mm','a4');
        p.addImage(i,'PNG',0,0,210,(c.height*210)/c.width);p.save('doc.pdf');
    });
}
function baixarBackup(){
    const b=new Blob([JSON.stringify({locadores,pecas,locacoes,devolucoes,tipos,config})],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='backup.json';a.click();
}
function restaurarBackup(i){
    if(!i.files[0])return;
    const r=new FileReader();
    r.onload=e=>{
        const d=JSON.parse(e.target.result);
        locadores=d.locadores||[];pecas=d.pecas||[];locacoes=d.locacoes||[];tipos=d.tipos||[];config=d.config||config;
        salvarLocal();renderTudo();alert('Restaurado');
    };
    r.readAsText(i.files[0]);
}
function arquivarHistorico(){
    devolucoes=devolucoes.filter(d=>locacoes.some(l=>l.id===d.locacaoId));
    locacoes=locacoes.filter(l=>l.status!=='devolvido');salvarLocal();renderTudo();mostrarToast('Arquivado');
}

// SCANNER E PREVIEWS
function iniciarScanner(m){
    const md=document.getElementById('modalScanner');md.classList.add('active');
    Quagga.init({inputStream:{name:"Live",type:"LiveStream",target:document.querySelector('#interactive')},decoder:{readers:["code_128_reader"]}},e=>{
        if(!e)Quagga.start();
    });
    Quagga.onDetected(r=>{
        const c=r.codeResult.code;
        if(m==='cadastro')document.getElementById('pecaBar').value=c;
        if(m==='locacao'){const p=pecas.find(x=>x.codigo===c);if(p){document.getElementById('aluguelItemSelect').value=p.id;mostrarToast('Item: '+p.nome);}}
        fecharScanner();
    });
}
function fecharScanner(){document.getElementById('modalScanner').classList.remove('active');try{Quagga.stop();}catch(e){}}
function converterLogo(){const i=document.getElementById('confLogo');if(i.files[0]){const r=new FileReader();r.onload=()=>{config.logo=r.result;renderConfig();};r.readAsDataURL(i.files[0]);}}
function gerarRelatorio(id){
    const l=locacoes.find(x=>x.id===id),c=locadores.find(x=>x.id===l.locadorId);
    if(!l)return;
    const h=`<div style="padding:20px; font-family:sans-serif;"><h2>MTZ Eventos - Contrato #${l.id}</h2><p>Cliente: ${c?c.nome:'-'}</p><hr><h3>Itens:</h3><ul>${l.items.map(i=>`<li>${i.quantidade}x ${i.nome}</li>`).join('')}</ul></div>`;
    document.getElementById('printArea').innerHTML=h;document.getElementById('modalRelatorio').classList.add('active');
}
</script>
</body>
</html>
